<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S A M A N T H A | S O F T C O D E</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Space Mono (é—œéµå­—é«”) & Inter -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- å¼•å…¥ Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ï¼šLight Theme (Production Ready) --- */
        :root {
            --base-bg: #FAF9F6;
            /* å¥¶æ²¹ç™½/ç‡•éº¥è‰² */
            --grid-border: #BBBBBB;
            /* æ¥µç´°ç°ç·š */
            --primary-text: #333333;
            /* æ·±ç‚­ç° */
            --code-comment: #666666;
            /* è¨»è§£è‰² */
            --accent: #FF3333;
            /* çµ±ä¸€ä½¿ç”¨è­¦ç¤ºç´… */
            --accent-dark: #CC0000;
            /* æ·±ç´…è‰² */
            --line-black: #111111;
            /* ç·šæ¢å‹•ç•«å°ˆç”¨é»‘ */
            --line-red: #FF3333;
            /* è­¦ç¤ºç´… (Glitch/Target) */
        }

        /* --- å…¨ç«™åŸºç¤è¨­å®š --- */
        body {
            font-family: 'Inter', Arial, sans-serif;
            color: var(--primary-text);
            background-color: var(--base-bg);
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            cursor: crosshair;
            /* UX: å…¨ç«™æº–å¿ƒæ¸¸æ¨™ */
        }

        /* è‡ªå®šç¾©æ¸¸æ¨™è·Ÿéš¨æ–‡å­— (Tooltip) */
        #cursor-tooltip {
            position: fixed;
            pointer-events: none;
            background: var(--line-red);
            color: white;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 2px;
            z-index: 99999;
            opacity: 0;
            transform: translate(15px, 15px);
            transition: opacity 0.1s;
            white-space: nowrap;
        }

        /* --- 1. Intro Animation Layers --- */
        #canvas-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9998;
            pointer-events: none;
            mix-blend-mode: multiply;
            transition: opacity 1.5s ease-out;
        }

        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(250, 249, 246, 0.4);
            cursor: pointer;
            transition: opacity 0.5s;
        }

        #intro-text-box {
            transition: opacity 0.8s ease-out;
            opacity: 1;
        }

        #skip-intro {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10000;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--primary-text);
            border: 1px solid var(--primary-text);
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        #skip-intro:hover {
            background: var(--primary-text);
            color: var(--base-bg);
        }

        .blink-text {
            animation: blinker 0.1s steps(2, start) infinite;
            font-family: 'Space Mono', monospace;
            color: var(--line-black);
            text-transform: uppercase;
            letter-spacing: 2px;
            background: white;
            padding: 5px 10px;
        }

        @keyframes blinker {
            to {
                opacity: 0;
            }
        }
        /* NEW: Cursor Blink Animation for File List */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .animate-blink-cursor {
            animation: blink 1s step-end infinite;
            color: var(--accent); /* Red cursor */
            font-weight: bold;
        }
        /* --- 2. Main Site Wrapper --- */
        #site-wrapper {
            opacity: 0;
            transition: opacity 2s ease-in;
            background-color: var(--base-bg);
            min-height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* --- 3. Styles & Grid --- */
        .ikeda-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0;
            background: linear-gradient(rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.015) 50%), linear-gradient(90deg, rgba(0, 0, 0, 0.015) 1px, transparent 1px);
            background-size: 100% 2px, 20px 20px;
        }

        #data-ticker-container {
            overflow: hidden;
            background-color: #f5f5f5;
            border-bottom: 1px solid var(--grid-border);
            padding: 5px 0;
            z-index: 20;
            position: relative;
        }

        #data-ticker {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--code-comment);
            white-space: nowrap;
            display: inline-block;
            padding-left: 100%;
            animation: ticker-flow 18s linear infinite;
        }

        @keyframes ticker-flow {
            to {
                transform: translateX(-100%);
            }
        }

        .data-barcode-strip {
            width: 100%;
            height: 12px;
            background-color: var(--base-bg);
            overflow: hidden;
            position: relative;
            margin-bottom: 4rem;
        }

        .data-barcode-strip::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background-image: repeating-linear-gradient(90deg,
                    rgba(0, 0, 0, 0.1) 0px, rgba(0, 0, 0, 0.1) 1px,
                    transparent 1px, transparent 4px,
                    rgba(0, 0, 0, 0.1) 4px, rgba(0, 0, 0, 0.1) 6px,
                    transparent 6px, transparent 15px,
                    rgba(0, 0, 0, 0.2) 15px, rgba(0, 0, 0, 0.2) 16px,
                    transparent 16px, transparent 25px);
            background-size: 25px 100%;
            animation: data-flow 30s cubic-bezier(0.65, 0, 0.35, 1) infinite,
                granularity-pulse 8s ease-in-out infinite alternate;
        }

        /* --- ç¯©é¸æŒ‰éˆ•æ¨£å¼ --- */
        .filter-btn {
            border: 1px solid #ccc;
            background: white;
            transition: all 0.2s;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            /* text-xs */
        }

        .filter-btn:hover {
            border-color: black;
            background: black;
            color: white;
        }

        .filter-btn.active {
            border-color: black;
            background: black;
            color: white;
        }

        /* Mobile Filter Horizontal Scroll Optimized */
        #filter-row-character,
        #filter-row-type {
            flex-wrap: nowrap;
            /* ä¸æ›è¡Œ */
            overflow-x: auto;
            /* å¯æ©«å‘æ»‘å‹• */
            padding-bottom: 5px;
            /* ç•™é»ç©ºé–“çµ¦æ²è»¸ */
            -webkit-overflow-scrolling: touch;
            /* iOS æ»‘å‹•é †æš¢ */
        }

        /* é˜²æ­¢æŒ‰éˆ•åœ¨æ©«å‘æ’åˆ—æ™‚è¢«å£“ç¸® */
        #filter-row-character button,
        #filter-row-type button {
            flex-shrink: 0;
        }

        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        #filter-row-character::-webkit-scrollbar,
        #filter-row-type::-webkit-scrollbar {
            display: none;
        }

        @keyframes data-flow {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        @keyframes granularity-pulse {
            0% {
                background-size: 25px 100%;
            }

            50% {
                background-size: 40px 100%;
            }

            100% {
                background-size: 25px 100%;
            }
        }

        .hacker-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            line-height: 1.2;
            gap: 2px;
            cursor: pointer;
        }

        .brand-name {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            color: var(--primary-text);
            text-transform: uppercase;
        }

        .code-wrapper {
            position: relative;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            color: var(--code-comment);
            letter-spacing: 0.15em;
            padding-bottom: 5px;
        }

        .bracket {
            color: var(--primary-text);
            font-weight: 700;
        }

        .glitch-underline {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--line-red);
            animation: breathe-line 4s ease-in-out infinite;
            box-shadow: 0 0 5px var(--line-red);
        }

        @keyframes breathe-line {

            0%,
            100% {
                opacity: 0.3;
                transform: scaleX(0.8);
            }

            50% {
                opacity: 1;
                transform: scaleX(1);
            }
        }

        @media (max-width: 640px) {
            .brand-name {
                font-size: 1.5rem;
                letter-spacing: 0.15em;
            }

            .code-wrapper {
                font-size: 0.75rem;
            }
        }

        .mobile-logo-break {
            display: none;
        }

        @media (max-width: 1023px) {
            .mobile-logo-break {
                display: block;
                content: " ";
                height: 0;
            }
        }

        #main-title {
            font-family: 'Space Mono', monospace;
            font-weight: 400;
            font-size: 1rem;
            letter-spacing: 0.1em;
            color: var(--code-comment);
            margin-bottom: 5rem;
            text-transform: none;
        }

        .product-name,
        .category-info h2 {
            font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif !important;
            font-weight: 700;
        }

        #detail-name {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            font-size: 2.2rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .product-price {
            font-family: 'Space Mono', monospace;
            color: var(--primary-text);
            font-weight: bold;
        }

        .data-decoration {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--code-comment);
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }

        .product-grid-container {
            background-color: var(--grid-border);
            padding: 1px;
            margin: 0 auto;
        }

        .product-grid {
            gap: 1px 1px;
            background-color: var(--base-bg);
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        @media (min-width: 640px) {
            .product-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .product-card {
            background-color: var(--base-bg);
            padding: 30px;
            transition: none;
            border: 1px solid transparent;
            position: relative;
        }

        /* æ²¿ç”¨å‰›å‰›çš„å‹•ç•«å®šç¾© (å¦‚æœæ²’æœ‰è«‹åŠ ä¸Š) */
        @keyframes glitch-hard {
            0% {
                transform: translate(0, 0) skew(0deg);
            }

            20% {
                transform: translate(-3px, 2px) skew(-2deg);
            }

            40% {
                transform: translate(-3px, -2px) skew(2deg);
            }

            60% {
                transform: translate(3px, 2px) skew(0deg);
            }

            80% {
                transform: translate(3px, -2px) skew(-1deg);
            }

            100% {
                transform: translate(0, 0) skew(0deg);
            }
        }

        .product-card:hover img {
            /* invert(1): 100% è² ç‰‡åè½‰
               contrast(1.5): æé«˜å°æ¯”ï¼Œè®“è² ç‰‡çœ‹èµ·ä¾†æ›´ã€Œç¡¬ã€ã€æ›´é›»å­åŒ–ï¼Œä¸æœƒç°ç°çš„
               saturate(0): (é¸ç”¨) å¦‚æœæƒ³è¦ç´”é»‘ç™½è² ç‰‡ï¼ŒåŠ ä¸Šé€™è¡Œï¼›æƒ³ä¿ç•™è©­ç•°é¡è‰²å‰‡æ‹¿æ‰
            */
            filter: invert(1) contrast(1.5);

            /* æ··åˆæ¨¡å¼ï¼šdifference æœƒè®“åœ–ç‰‡è·ŸèƒŒæ™¯è‰²åšå·®å€¼é‹ç®—ï¼Œ
               é€™åœ¨æ·ºè‰²èƒŒæ™¯ä¸Šæ•ˆæœæ¥µä½³ï¼Œæœƒè®“åœ–ç‰‡é‚Šæ¡†æ¶ˆå¤±ï¼Œèé€²èƒŒæ™¯è£¡ */
            mix-blend-mode: difference;

            /* ä¿æŒè·³å‹•å‹•ç•« */
            animation: glitch-hard 0.2s steps(2) infinite;
        }


        .detail-original-price {
            color: var(--code-comment);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            text-decoration: line-through;
            margin-bottom: 0;
            display: block;
        }

        .detail-price {
            font-family: 'Space Mono', monospace;
            font-weight: 800;
        }

        .product-card:hover img {
            animation: glitch-anim 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
            filter: contrast(1.1) saturate(0.8);
        }

        @keyframes glitch-anim {
            0% {
                transform: translate(0);
            }

            20% {
                transform: translate(-2px, 2px);
            }

            40% {
                transform: translate(-2px, -2px);
            }

            60% {
                transform: translate(2px, 2px);
            }

            80% {
                transform: translate(2px, -2px);
            }

            100% {
                transform: translate(0);
            }
        }

        .hidden {
            display: none !important;
        }

        /* --- Full Screen Navigation Overlay --- */
        #nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(250, 249, 246, 0.95);
            /* åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #nav-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        #nav-overlay a {
            font-family: 'Space Mono', monospace;
            font-size: 2rem;
            color: var(--primary-text);
            text-decoration: none;
            margin: 10px 0;
            padding: 10px 20px;
            border: 1px solid transparent;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        #nav-overlay a:hover {
            border: 1px solid var(--accent);
            color: var(--accent);
            background-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.05);
        }

        #close-nav-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary-text);
            background: none;
            border: none;
        }

        /* --- Data Index List View --- */
        .data-index-container {
            position: relative;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-top: 1px solid var(--grid-border);
            border-bottom: 1px solid var(--grid-border);
            margin-bottom: 40px;
        }

        /* èƒŒæ™¯åœ–ç‰‡é è¦½å€ (é è¨­éš±è—) */
        #index-preview-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 0;
            filter: grayscale(100%) contrast(120%);
            /* ä¿æŒå†·å†½æ„Ÿ */
            pointer-events: none;
        }

        /* åˆ—è¡¨é …ç›® */
        .index-item {
            position: relative;
            z-index: 10;
            font-family: 'Space Mono', monospace;
            /* ç­‰å¯¬å­—é«”æ˜¯é—œéµ */
            font-size: 1.5rem;
            /* å¤§ä¸€é» */
            padding: 20px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.7);
            /* åŠé€æ˜ç™½ï¼Œè®“å­—åœ¨åœ–ä¸Šçœ‹å¾—è¦‹ */
        }

        .index-item:last-child {
            border-bottom: none;
        }

        /* Hover ç‰¹æ•ˆ */
        .index-item:hover {
            background: rgba(255, 255, 255, 0.2);
            /* è®Šæ›´é€æ˜åº¦ */
            color: var(--accent);
            /* è®Šç´… */
            padding-left: 40px;
            /* å‘å³ç¸®æ’ */
        }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 768px) {
            .index-item {
                font-size: 1rem;
                padding: 15px 10px;
            }

            .index-item:hover {
                padding-left: 20px;
            }
        }

        .text-black {
            color: var(--primary-text) !important;
        }

        .border-black {
            border-color: var(--primary-text) !important;
        }

        .bg-light-purple {
            background-color: var(--base-bg);
        }

        .add-to-cart {
            background-color: var(--primary-text);
            color: white;
            border: 1px solid var(--primary-text);
            font-family: 'Space Mono', monospace;
            font-weight: bold;
        }

        .add-to-cart:hover {
            background-color: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .border-accent {
            border-color: var(--accent) !important;
        }

        .variation-button {
            border: 1px solid var(--grid-border);
            color: var(--primary-text);
            background-color: var(--base-bg);
        }

        .variation-button:not(:disabled):hover {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .ring-accent-color {
            box-shadow: 0 0 0 2px var(--accent);
            border-color: var(--accent) !important;
        }

        @keyframes pulse-accent {
            0% {
                transform: scale(1);
                background-color: var(--accent);
            }

            50% {
                transform: scale(1.05);
                background-color: var(--accent-dark);
            }

            100% {
                transform: scale(1);
                background-color: var(--accent);
            }
        }

        .add-to-cart.animate-pulse {
            animation: pulse-accent 0.3s ease-in-out 3;
        }

        .filter-controls select {
            font-family: 'Space Mono', monospace;
            border-radius: 0;
            border: 1px solid var(--grid-border);
            color: var(--primary-text);
            background-color: transparent;
            padding: 4px 10px;
        }

        .vertical-category-card {
            border: 1px solid var(--grid-border);
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

        .vertical-category-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        .category-image-container img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            margin-bottom: 15px;
            filter: grayscale(20%);
        }

        .vertical-category-card:hover .category-image-container img {
            filter: grayscale(0%);
        }

        .category-info h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-text);
        }

        .category-view-link {
            display: inline-block;
            margin-top: 15px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            text-decoration: underline;
            color: var(--accent);
        }

        .log-item {
            border-bottom: 1px solid var(--grid-border);
            padding: 15px 0;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
        }

        .log-date {
            display: block;
            color: var(--code-comment);
            margin-bottom: 4px;
        }

        .log-category {
            color: var(--accent);
            margin-right: 8px;
            font-weight: bold;
        }

        .log-content {
            color: var(--primary-text);
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- UX: Custom Tooltip -->
    <div id="cursor-tooltip">TARGET ACQUIRED</div>

    <!-- Skip Intro Button -->
    <button id="skip-intro">[ SKIP INTRO ]</button>

    <!-- Phase 0: Intro -->
    <div id="intro-overlay">
        <div id="intro-text-box"
            class="text-xs tracking-[0.5em] text-black text-center bg-white p-4 border border-black">
            [ SYSTEM INITIALIZING... ]
            <br><br>
            <span class="blink-text" id="intro-status">_LOADING_DATA_</span>
            <br><br>
            <span class="text-gray-500 text-[10px]">( Click to Enable Audio )</span>
        </div>
    </div>
    <canvas id="canvas-layer"></canvas>

    <!-- Phase 1: Main Site -->
    <div id="site-wrapper">

        <div class="ikeda-grid"></div>
        <header class="border-b border-black py-3 px-4 sm:px-10 sticky top-0 z-50 bg-base-bg/90 backdrop-blur-sm">
            <!-- ä¿®æ­£çµæ§‹ï¼šw-full + justify-between -->
            <nav class="flex justify-between items-center w-full relative h-16">
                <!-- LOGO (æ°¸é åœ¨å·¦) - æ”¹ç”¨ SVG åœ–ç‰‡å¼•ç”¨æ¨¡å¼ -->
                 <!-- LOGO (æ°¸é åœ¨å·¦) - æ”¹ç”¨ SVG åœ–ç‰‡å¼•ç”¨æ¨¡å¼ -->
                 <a href="#" class="hacker-logo z-50 flex items-center text-black hover:text-[#FF3333] transition-colors" onclick="showLandingPage()">
                    <!-- æ”¹è£å¾Œçš„ Inline SVG -->
                    <!-- viewBox="0 200 600 200" æ˜¯ç‚ºäº†è£åˆ‡æ‰åŸæœ¬ SVG ä¸Šä¸‹å¤šé¤˜çš„ç©ºç™½ï¼Œè®“æ–‡å­—è‡ªå‹•æ”¾å¤§å¡«æ»¿ -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 200 600 200" class="w-auto h-20 md:h-24 -ml-4 md:-ml-6 relative top-1">
                      <defs>
                        <style>
                          /* å‘¼å¸å‹•ç•« */
                          @keyframes breathe-line {
                            0%, 100% { opacity: 0.3; transform: scaleX(0.8); }
                            50% { opacity: 1; transform: scaleX(1); }
                          }
                       
                          .brand-text {
                            font-family: 'Inter', sans-serif;
                            font-weight: 900;
                            font-size: 56px;
                            letter-spacing: 0.1em;
                            fill: currentColor; /* é—œéµï¼šä½¿ç”¨ currentColor è®“å®ƒè·Ÿéš¨ Tailwind çš„ hover:text-red */
                            text-anchor: middle;
                            text-transform: uppercase;
                          }
                       
                          .code-text {
                            font-family: 'Space Mono', monospace;
                            font-weight: 600;
                            font-size: 24px;
                            letter-spacing: 0.15em;
                            fill: currentColor; /* é—œéµï¼šè·Ÿéš¨çˆ¶å±¤é¡è‰² */
                            text-anchor: middle;
                            opacity: 0.7;
                          }
                       
                          .bracket {
                            fill: currentColor;
                            font-weight: 700;
                          }
                       
                          .glitch-line {
                            fill: #FF3333; /* é€™æ¢ç·šç¶­æŒç´…è‰²ï¼Œä¸éš¨ hover è®Šè‰²ï¼Œä½œç‚ºé»ç¶´ */
                            transform-box: fill-box;
                            transform-origin: center;
                            animation: breathe-line 4s ease-in-out infinite;
                          }
                        </style>
                      </defs>
                       
                      <!-- 1. ä¸»æ¨™é¡Œ (ä½ç½®å¾®èª¿ä»¥é©æ‡‰æ–°çš„ viewBox) -->
                      <text x="50%" y="280" class="brand-text">SAMANTHA</text>
                       
                      <!-- 2. å‰¯æ¨™é¡Œ -->
                      <g transform="translate(300, 320)"> <!-- ç§»åˆ°æ°´å¹³ä¸­å¿ƒ -->
                        <text x="0" y="0" class="code-text">
                          <tspan class="bracket">[</tspan> SOFT_CODE <tspan class="bracket">]</tspan>
                        </text>
                         
                        <!-- 3. ç´…è‰²å‘¼å¸åº•ç·š -->
                        <rect x="-110" y="10" width="220" height="3" class="glitch-line" />
                      </g>
                    </svg>
                </a>

                <!-- Full Screen Navigation Overlay -->
                <div id="nav-overlay">
                    <button id="close-nav-btn">[ CLOSE_SYSTEM ]</button>
                    <div id="nav-links-container" class="flex flex-col items-center">
                        <!-- JS Generated Links -->
                    </div>
                </div>

                 <!-- å³å´ç¾¤çµ„ï¼šåŠŸèƒ½æŒ‰éˆ• (æ°¸é åœ¨å³) -->
                <!-- ä¿®æ­£ï¼šæ”¹æˆ SVG åœ–ç¤ºæŒ‰éˆ•ï¼Œæ–‡å­—åœ¨æ‰‹æ©Ÿéš±è— -->
                <div class="flex items-center gap-1.5 md:gap-2 z-50">
                    <!-- è³¼ç‰©è»ŠæŒ‰éˆ• -->
                    <button id="cart-toggle"
                        class="text-xs font-mono uppercase border border-black px-1.5 py-1.5 md:px-3 md:py-1 transition duration-200 hover:bg-black hover:text-white text-black flex items-center justify-center gap-2 whitespace-nowrap min-w-[36px] md:min-w-auto">
                        <!-- Icon (Mobile Only or Always Visible depending on preference, here SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:hidden"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                         
                        <!-- Text (Hidden on Mobile) -->
                        <span class="hidden md:!inline">[ CART : <span id="cart-count">0</span> ]</span>
                         
                        <!-- Count Badge for Mobile (Visible only on small screens) -->
                        <span class="md:hidden text-[10px] font-bold" id="cart-count-mobile">0</span>
                    </button>

                    <!-- éŸ³æ•ˆæŒ‰éˆ• -->
                    <button id="audio-toggle"
                        class="text-xs font-mono uppercase border border-black px-1.5 py-1.5 md:px-3 md:py-1 transition duration-200 hover:bg-black hover:text-white text-black flex items-center justify-center whitespace-nowrap min-w-[36px] md:min-w-auto">
                        <!-- Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                         
                        <!-- Text -->
                        <span class="hidden md:!inline">[ AUDIO OFF ]</span>
                    </button>

                    <!-- ç³»çµ±é¸å–®æŒ‰éˆ• -->
                    <button id="menu-toggle" class="text-xs font-mono font-bold cursor-pointer text-black border border-black px-1.5 py-1.5 md:px-3 md:py-1 hover:bg-black hover:text-white transition whitespace-nowrap flex items-center justify-center min-w-[36px] md:min-w-auto">
                        <!-- Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:hidden"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                         
                        <!-- Text -->
                        <span class="hidden md:!inline">[ SYSTEM_MENU ]</span>
                    </button>
                </div>
            </nav>
        </header>

        <div id="data-ticker-container">
            <span id="data-ticker">S Y S T E M &nbsp; O N L I N E &nbsp; . . . &nbsp; C U R A T E D &nbsp; D A T A
                &nbsp; R E C O R D &nbsp; I N I T I A T E D &nbsp; . . . &nbsp; V E R &nbsp; 1 . 0 . 1 &nbsp; . . .
                &nbsp; 0 0 1 0 1 1 0 &nbsp; 1 1 0 1 0 0 1 0 1 0 1 0 &nbsp; 0 0 1 1 1 1 0</span>
        </div>

        <div class="data-barcode-strip"></div>

        <main class="max-w-7xl mx-auto px-4 sm:px-10 py-12">
            <h1 id="main-title" class="font-normal text-center tracking-widest text-black">ã€ // CURATED ARCHIVE ã€‘</h1>

            <div id="landing-view">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-grow">
                        <h2 class="text-2xl font-mono mb-6 text-black">:: DATA_INDEX_PROTOCOL</h2>
                        <!-- æ•¸æ“šç´¢å¼•åˆ—è¡¨å®¹å™¨ -->
                        <div class="data-index-container" id="data-index">
                            <img id="index-preview-bg" src="" alt="">
                            <!-- JS Generated Items -->
                        </div>
                    </div>
                    <div class="md:w-1/3 mt-8 md:mt-0">
                        <h2 class="text-2xl font-mono mb-6 text-black">:: S Y S T E M _ L O G</h2>
                        <div id="system-log-container">
                            <!-- JS Generated -->
                        </div>
                    </div>
                </div>
            </div>
 
            <!-- WORK / ART VIEW (NEW SECTION) -->
            <div id="work-view" class="hidden h-screen flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b border-black flex justify-between items-center bg-[#FAF9F6] flex-shrink-0">
                    <h2 class="font-mono text-xl text-[#FF3333] animate-pulse">FATAL_EXCEPTION_0x89A</h2>
                    <button onclick="showLandingPage()" class="font-mono text-xs hover:bg-black hover:text-white border border-black px-2 py-1 transition">
                        [ RETURN_TO_SAFE_MODE ]
                    </button>
                </div>
                 
                <!-- Content Container: Flex for desktop (row), col for mobile -->
                <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
                    <!-- P5.js Container -->
                    <div class="w-full md:w-2/3 h-1/2 md:h-full relative bg-black border-b md:border-b-0 md:border-r border-black">
                        <div id="p5-loading" class="absolute inset-0 flex items-center justify-center text-[#FF3333] font-mono text-sm z-0">
                            LOADING_ART_MODULE...
                        </div>
                        <iframe id="art-frame" class="w-full h-full border-none relative z-10" title="Generative Art"></iframe>
                    </div>

                    <!-- Creative Text Description Area -->
                    <div class="w-full md:w-1/3 h-1/2 md:h-full bg-[#FAF9F6] p-6 overflow-y-auto font-mono text-sm flex flex-col">
                         
                        <!-- File Selector List -->
                        <div class="mb-8 border-b border-black pb-4">
                            <div class="text-xs text-gray-500 mb-2 font-bold tracking-widest">[ FILE_SYSTEM ]</div>
                            <div id="art-file-list" class="flex flex-col gap-2">
                                <!-- JS Generated Buttons will go here -->
                            </div>
                        </div>

                        <!-- Dynamic Content -->
                        <div class="flex-grow">
                            <div class="text-gray-500 mb-2 text-xs">
                                // ARTIST_STATEMENT.txt<br>
                                // READ_ONLY_MODE
                            </div>
                            <h3 id="art-title" class="font-bold text-lg mb-4 text-black"></h3>
                            <div id="art-desc" class="mb-4 leading-relaxed text-gray-700 whitespace-pre-line"></div>
                        </div>

                        <!-- Meta Info Footer -->
                        <div class="mt-auto border-t border-dashed border-gray-400 pt-4">
                            <p id="art-meta" class="text-xs text-gray-500 font-mono leading-relaxed">
                                <!-- JS Generated Meta -->
                            </p>
                        </div>
                    </div>
                </div>
                 
                <!-- Footer -->
                <div class="border-t border-black p-2 text-center font-mono text-xs text-gray-500 bg-[#FAF9F6] flex-shrink-0">
                    [ INTERACTIVE_MODE: ENABLED ]
                </div>
            </div>

            <!-- èˆŠç‰ˆä¸‹æ‹‰é¸å–®å·²ç§»é™¤ -->

            <div class="flex flex-col gap-3">

                <!-- 1. è§’è‰²ç¯©é¸ (åƒ…ä¸‰éº—é·—é¡¯ç¤º) -->
                <div id="filter-row-character" class="flex flex-wrap items-center gap-2 hidden">
                    <span class="font-mono text-[10px] text-gray-400 w-16">CHAR ::</span>
                    <!-- JS å‹•æ…‹ç”ŸæˆæŒ‰éˆ• -->
                    <div id="char-btn-group" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- 2. å“é …ç¯©é¸ (é€šç”¨) -->
                <div id="filter-row-type" class="flex flex-wrap items-center gap-2">
                    <span class="font-mono text-[10px] text-gray-400 w-16">TYPE ::</span>
                    <button onclick="toggleFilter('type', 'åŠé£¾')"
                        class="filter-btn px-3 py-1 text-xs rounded-full">åŠé£¾/é‘°åŒ™åœˆ</button>
                    <button onclick="toggleFilter('type', 'ç©å¶')"
                        class="filter-btn px-3 py-1 text-xs rounded-full">å¨ƒå¨ƒ/ç©å¶</button>
                    <button onclick="toggleFilter('type', 'æ”¶ç´')"
                        class="filter-btn px-3 py-1 text-xs rounded-full">æ”¶ç´/åŒ…è¢‹</button>
                    <button onclick="toggleFilter('type', 'æ–‡å…·')"
                        class="filter-btn px-3 py-1 text-xs rounded-full">æ–‡å…·/è²¼ç´™</button>
                    <button onclick="toggleFilter('type', 'é›œè²¨')"
                        class="filter-btn px-3 py-1 text-xs rounded-full">ç”Ÿæ´»/é›œè²¨</button>
                </div>
            </div>
            <div class="product-grid-container hidden" id="product-grid-container">
                <div id="product-grid" class="product-grid grid"></div>
            </div>
            <!-- ç„¡çµæœæç¤º -->
            <div id="empty-state" class="hidden py-20 text-center">
                <p class="text-4xl mb-4">ğŸ‘»</p>
                <p class="font-mono text-sm text-gray-500">NO_DATA_FOUND</p>
                <button onclick="clearSubFilters()" class="mt-4 text-xs underline hover:text-[#FF3333]">RESET
                    FILTERS</button>
            </div>
            <div id="product-detail-view" class="product-detail-view hidden pt-10">
                <button id="back-to-grid"
                    class="back-button text-sm mb-10 cursor-pointer p-0 border-none bg-transparent text-gray-500 hover:text-black">â†
                    è¿”å›ç”¢å“åˆ—è¡¨</button>
                <div class="detail-content flex flex-col lg:flex-row lg:space-x-16">
                    <div class="detail-image-container flex-1 mb-8 lg:mb-0">
                        <img id="detail-main-image" src="" alt="ç”¢å“åœ–ç‰‡"
                            class="w-full h-auto object-cover mb-4 rounded-lg border border-gray-200">
                        <div id="detail-thumbnails" class="flex space-x-2 mt-4 overflow-x-auto pb-2"></div>
                    </div>
                    <div class="detail-info flex-1 pt-0 lg:pt-12">
                        <!-- éš±è—çš„ ID æ¬„ä½ -->
                        <span id="product_id" class="hidden"></span>

                        <h2 id="detail-name" class="mb-2 uppercase text-black"></h2>
                        <p id="detail-original-price"
                            class="detail-original-price text-xl font-mono line-through mb-1 hidden"></p>
                        <p class="detail-price text-xl font-extrabold mb-6" id="detail-price-range"></p>
                        <div class="variation-selection mb-10">
                            <h3 class="text-lg font-semibold mb-3 text-black">é¸æ“‡æ¬¾å¼ / è®Šé«”:</h3>
                            <div id="variation-options" class="flex flex-wrap gap-3"></div>
                        </div>
                        <div class="detail-description leading-relaxed mb-10 text-gray-700">
                            <p>é€™æ˜¯ Samantha ç‚ºæ‚¨ç²¾å¿ƒæŒ‘é¸çš„ç™‚ç™’å°ç‰©ã€‚æ¯ä¸€ä»¶ç”¢å“éƒ½å……æ»¿æº«æš–èˆ‡æ„›ï¼Œå¸Œæœ›èƒ½ç‚ºæ‚¨çš„ç”Ÿæ´»å¸¶ä¾†ä¸€çµ²ç”œç¾çš„é™ªä¼´å’Œæ”¾é¬†çš„æ°›åœã€‚</p>
                            <ul class="list-none mt-6 space-y-2" style="color: var(--primary-text); font-size: 0.9rem;">
                                <li>ä¸»é¡Œï¼šç”œèœœå¤¢å¢ƒ</li>
                                <li>é©ç”¨ï¼šç™‚ç™’èº«å¿ƒã€é€ç¦®è‡ªç”¨</li>
                                <li>ä¿é¤Šï¼šè¼•æŸ”æ‰‹æ´—ï¼Œè‡ªç„¶é¢¨ä¹¾</li>
                            </ul>
                        </div>
                        <button
                            class="w-full py-4 add-to-cart uppercase text-base transition duration-200">åŠ å…¥è³¼ç‰©è»Š</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer / Creator Credit -->
        <footer class="border-t border-dashed border-gray-400 py-6 mt-12 text-center font-mono text-[10px] text-gray-500">
            <div class="mb-2">
                SYSTEM_VER_2.0 // DEVELOPED_BY <a href="#" class="text-black hover:text-[#FF3333] transition-colors border-b border-gray-400 hover:border-[#FF3333]">[ SAMANTHA PAN ]</a>
            </div>
            <div>
                Â© 2024 SAMANTHA_ARCHIVE. ALL RIGHTS RESERVED.
            </div>
        </footer>

        <!-- CART DRAWER / SIDEBAR -->
        <div id="cart-overlay" class="fixed inset-0 bg-black/50 z-[9998] hidden backdrop-blur-sm transition-opacity">
        </div>
        <div id="cart-sidebar"
            class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-white border-l border-black z-[9999] transform translate-x-full transition-transform duration-300 flex flex-col shadow-2xl">
            <!-- Cart Header -->
            <div class="p-6 border-b border-black flex justify-between items-center bg-gray-50">
                <h2 class="font-mono text-lg font-bold tracking-widest">[ CART_LOG ]</h2>
                <button id="close-cart" class="text-black hover:text-red-600 font-mono text-xl">[X]</button>
            </div>

            <!-- Cart Items Area -->
            <div id="cart-items-container" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- JS æœƒå°‡å•†å“æ’å…¥é€™è£¡ -->
                <div class="text-center text-gray-400 font-mono text-sm mt-10">
                    :: NULL_DATA ::<br>è³¼ç‰©è»Šæ˜¯ç©ºçš„
                </div>
            </div>

            <!-- Cart Footer / Checkout -->
            <div class="p-6 border-t border-black bg-gray-50">
                <div class="flex justify-between font-mono text-sm mb-4">
                    <span>TOTAL_CALC:</span>
                    <span id="cart-total" class="font-bold">NT$ 0</span>
                </div>
                <!-- çµå¸³æŒ‰éˆ•æ–‡å­—æ›´æ–° -->
                <button id="checkout-btn"
                    class="w-full py-3 bg-black text-white font-mono hover:bg-[#FF3333] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed uppercase font-bold text-sm tracking-wider">
                    [ SEND TO GOOGLE FORM ]
                </button>
                <p class="text-[10px] text-gray-500 mt-2 font-mono text-center leading-tight">
                    * é»æ“Šå¾Œè·³è½‰è‡³è¨‚å–®è¡¨å–®ï¼Œè«‹ç¢ºèªè³‡æ–™å¾Œæäº¤ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION (è«‹ä¿®æ”¹é€™è£¡)
        // ==========================================
        // 1. ä½ çš„ Google è¡¨å–®ç¶²å€ (è«‹æ›æˆä½ çš„)
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/YOUR_FORM_ID_HERE/viewform";

        // 2. ä½ çš„ã€Œè¨‚å–®å…§å®¹ã€æ¬„ä½ ID (è«‹æ›æˆä½ çš„)
        // åœ¨ Google è¡¨å–®ã€Œå–å¾—é å¡«é€£çµã€ä¸­æ‰¾åˆ° &entry.xxxxxxx=...
        const ORDER_FIELD_ID = "entry.123456789";

        // 3. å“ç‰Œèˆ‡åˆ†é¡è¨­å®š (Brand JSON)
        const BRAND_CONFIG = [
            { brand: "å…§è¤²å…” (Opanchu)", major_category: "ç©å¶/ç©å…·", sub_category: "ç©å¶" },
            { brand: "ä¸‰éº—é·— (Sanrio)", major_category: "ç©å¶/ç©å…·", sub_category: "ç©å¶" },
            { brand: "å´”é«˜èˆˆ (Choigosim)", major_category: "æ–‡å…·/è¾¦å…¬", sub_category: "è²¼ç´™" },
            { brand: "Le Labo", major_category: "ç¾å¦/ä¿é¤Š", sub_category: "é¦™æ°´" },
            { brand: "Puppet Sunsun", major_category: "åŒ…è¢‹/æ”¶ç´", sub_category: "è³¼ç‰©è¢‹" }
        ];

        // é è¨­é¦–é é¡¯ç¤ºçš„é‡é»å“ç‰Œ
        const FEATURED_BRANDS = ["å…§è¤²å…” (Opanchu)", "ä¸‰éº—é·— (Sanrio)", "å´”é«˜èˆˆ (Choigosim)"];

        // ==========================================
        // PART 1: DATAMATICS PARTICLE ENGINE
        // ==========================================
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const overlay = document.getElementById('intro-overlay');
        const overlayTextBox = document.getElementById('intro-text-box');
        const siteWrapper = document.getElementById('site-wrapper');
        const skipBtn = document.getElementById('skip-intro');

        let width, height;
        let particles = [];
        let targetPixels = [];
        let animationFrameId;

        const STATE = { CHAOS: 0, CONVERGE: 1, FORMED: 2, FADEOUT: 3, END: 4 };
        let currentState = STATE.CHAOS;
        let stateTimer = 0;
        let animationSoundPlayed = false;

        function resizeAnimation() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }

        function createTargetPixels() {
            // GUARD CLAUSE FOR ZERO DIMENSIONS
            if (!width || !height || width <= 0 || height <= 0) return [];

            const tempCanvas = document.createElement('canvas');
            const tCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
            tempCanvas.width = width;
            tempCanvas.height = height;

            let textLines = [];
            if (width < 768) {
                textLines = ["S A M A N T H A", "S O F T  C O D E"];
            } else {
                textLines = ["S A M A N T H A | S O F T C O D E"];
            }

            const longestLine = textLines.reduce((a, b) => a.length > b.length ? a : b);
            const charCount = longestLine.length;
            const estimatedWidthPerCharRatio = 0.65;
            const safeFontSize = (width * 0.9) / (charCount * estimatedWidthPerCharRatio);
            const maxFontSize = width < 768 ? 50 : 80;
            let fontSize = Math.floor(Math.min(maxFontSize, safeFontSize));
            fontSize = Math.max(12, fontSize);

            tCtx.font = `900 ${fontSize}px "Space Mono", monospace`;
            tCtx.fillStyle = '#000000';
            tCtx.textAlign = 'center';
            tCtx.textBaseline = 'middle';

            const lineHeight = fontSize * 1.6;
            const totalTextHeight = textLines.length * lineHeight;
            const startY = (height - totalTextHeight) / 2 + (lineHeight / 2);

            textLines.forEach((line, index) => {
                tCtx.fillText(line, width / 2, startY + (index * lineHeight) - (lineHeight * 0.2));
            });

            const imageData = tCtx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const pixels = [];
            const step = 3;

            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    if (data[(y * width + x) * 4 + 3] > 128) {
                        pixels.push({ x, y });
                    }
                }
            }
            return pixels;
        }

        class Particle {
            constructor(targetX, targetY) {
                this.targetX = targetX;
                this.targetY = targetY;
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.w = Math.random() * (width * 0.5) + 50;
                this.h = Math.random() * 4 + 2;
                this.vx = (Math.random() - 0.5) * 15;
                this.vy = 0;

                const rand = Math.random();
                if (rand > 0.7) this.color = '#111111';
                else this.color = 'rgba(17, 17, 17, 0.3)';
            }

            update() {
                if (currentState === STATE.CHAOS) {
                    this.x += this.vx;
                    if (this.x > width + this.w) this.x = -this.w;
                    if (this.x < -this.w) this.x = width + this.w;
                    if (Math.random() > 0.9) {
                        this.w = Math.random() * (width * 0.8) + 20;
                    }
                } else if (currentState === STATE.CONVERGE) {
                    this.x += (this.targetX - this.x) * 0.1;
                    this.y += (this.targetY - this.y) * 0.1;
                    this.w += (3 - this.w) * 0.1;
                    this.h = 3;
                    if (Math.abs(this.x - this.targetX) < 10) {
                        this.color = '#111111';
                    }
                } else if (currentState === STATE.FORMED) {
                    this.x = this.targetX;
                    this.y = this.targetY;
                    this.w = 3;
                    if (Math.random() > 0.995) {
                        this.w = Math.random() * 50 + 10;
                        this.x = this.targetX - this.w / 2;
                        this.color = '#FF3333';
                    } else {
                        this.color = '#111111';
                    }
                } else if (currentState === STATE.FADEOUT) {
                    this.w += Math.random() * 20;
                    this.h *= 0.9;
                    this.x += (Math.random() - 0.5) * 100;
                    this.color = 'rgba(17,17,17,0.1)';
                }
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(Math.floor(this.x), Math.floor(this.y), this.w, this.h);
            }
        }

        function initAnimation() {
            resizeAnimation();
            particles = [];
            targetPixels = createTargetPixels();

            const isMobile = width < 768;
            const bgParticleCount = isMobile ? 50 : 200;

            if (targetPixels.length > 0) {
                targetPixels.forEach(p => {
                    particles.push(new Particle(p.x, p.y));
                });
            }
            for (let i = 0; i < bgParticleCount; i++) {
                let p = new Particle(width / 2, height / 2);
                p.y = Math.random() * height;
                p.w = width;
                p.h = Math.random() * 1 + 0.5;
                p.vx = (Math.random() - 0.5) * 2;
                p.color = 'rgba(17, 17, 17, 0.05)';
                p.isBackground = true;
                particles.push(p);
            }
        }

        function animateLoop() {
            ctx.fillStyle = 'rgba(250, 249, 246, 0.2)';
            ctx.fillRect(0, 0, width, height);

            let convergedCount = 0;
            const textParticles = particles.filter(p => !p.isBackground);
            const totalTargetParticles = textParticles.length;

            particles.forEach(p => {
                if (p.isBackground) {
                    if (currentState === STATE.FADEOUT) {
                        p.h *= 0.9;
                    } else {
                        p.x += p.vx;
                        if (p.x > width) p.x = -width;
                        if (p.x < -width) p.x = width;
                    }
                    p.draw();
                } else {
                    p.update();
                    p.draw();
                    if (currentState === STATE.CONVERGE) {
                        const dist = Math.abs(p.x - p.targetX) + Math.abs(p.y - p.targetY);
                        if (dist < 5) convergedCount++;
                    }
                }
            });

            if (currentState === STATE.CHAOS) {
                stateTimer++;
                if (Math.random() > 0.98) {
                    ctx.fillStyle = 'rgba(17, 17, 17, 0.1)';
                    ctx.fillRect(0, 0, width, height);
                }
                if (stateTimer > 120) currentState = STATE.CONVERGE;
            } else if (currentState === STATE.CONVERGE) {
                if (overlayTextBox && overlayTextBox.style.opacity !== '0') {
                    overlayTextBox.style.opacity = '0';
                }
                if (totalTargetParticles > 0 && convergedCount / totalTargetParticles > 0.8) {
                    if (!animationSoundPlayed && isAudioOn) {
                        playIkedaSnap();
                        animationSoundPlayed = true;
                    }
                    currentState = STATE.FORMED;
                    stateTimer = 0;
                }
            } else if (currentState === STATE.FORMED) {
                stateTimer++;
                if (stateTimer > 280) {
                    endIntro();
                }
            }

            if (currentState !== STATE.END) {
                animationFrameId = requestAnimationFrame(animateLoop);
            }
        }

        function endIntro() {
            if (currentState === STATE.END) return;
            currentState = STATE.FADEOUT;
            overlay.style.opacity = '0';
            skipBtn.style.opacity = '0';
            siteWrapper.style.opacity = '1';
            canvas.style.opacity = '0';
            setTimeout(() => {
                canvas.remove();
                overlay.remove();
                skipBtn.remove();
                cancelAnimationFrame(animationFrameId);
                currentState = STATE.END;
            }, 2000);
        }

        // ==========================================
        // PART 2: MAIN SITE LOGIC & AUDIO
        // ==========================================

        let synth = null;
        let isAudioOn = false;
        let masterGain = null;
        let allProducts = [];
        // let categoryData = {}; // å·²ç”± BRAND_CONFIG å–ä»£
        let currentZone = null; // 'å…§è¤²å…”' or 'ä¸‰éº—é·—'
        let activeFilters = {
            character: null, // e.g., 'é…·æ´›ç±³'
            type: null       // e.g., 'å¨ƒå¨ƒ'
        };
        // const featuredCategories = ...; // å·²ç”± FEATURED_BRANDS å–ä»£

        function playIkedaSnap() {
            if (Tone && Tone.context.state === 'running') {
                const snapSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();
                snapSynth.triggerAttack("C7", Tone.now());
                snapSynth.frequency.rampTo(0, 0.1, Tone.now());
            }
        }

        function playSuccessArpeggio() {
            if (isAudioOn && synth) {
                const now = Tone.now();
                synth.triggerAttackRelease("C5", "32n", now);
                synth.triggerAttackRelease("E5", "32n", now + 0.1);
                synth.triggerAttackRelease("G5", "16n", now + 0.2);
            }
        }

        async function initAudioContext() {
            if (Tone && Tone.context.state !== 'running') {
                await Tone.start();
            }
            if (!synth && Tone) {
                masterGain = new Tone.Gain(0.4).toDestination();
                synth = new Tone.Synth({
                    oscillator: { type: "square" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }
                }).connect(masterGain);
            }
        }

        const audioToggleButton = document.getElementById('audio-toggle');
        if (audioToggleButton) {
            audioToggleButton.addEventListener('click', toggleAudio);
        }

        function toggleAudio() {
            if (Tone.context.state !== 'running') Tone.start();
            const button = document.getElementById('audio-toggle');
            if (isAudioOn) {
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                    <span class="hidden md:!inline">[ AUDIO OFF ]</span>
                `;
                button.classList.remove('bg-black', 'text-white');
                button.classList.add('text-black');
                isAudioOn = false;
            } else {
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    <span class="hidden md:!inline">[ AUDIO ON ]</span>
                `;
                button.classList.add('bg-black', 'text-white');
                button.classList.remove('text-black');
                isAudioOn = true;
                playBleep('G5', '32n');
            } 
        }

        function playBleep(note = "C5", duration = "64n") {
            if (isAudioOn && synth) {
                synth.triggerAttackRelease(note, duration, Tone.now());
            }
        }

        function generateDataDecoration(productId) {
            const ref = productId.slice(-4);
            const x = Math.floor(Math.random() * 899) + 100;
            const y = Math.floor(Math.random() * 89) + 10;
            return `[ REF: ${ref} // X: ${x} Y: ${y} ]`;
        }

        window.addEventListener('load', () => {
            initAnimation();
            if (width < 768) {
                currentState = STATE.CONVERGE;
            }
            animateLoop();
        });

        skipBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            endIntro();
        });

        overlay.addEventListener('click', async () => {
            await initAudioContext();
            toggleAudio();
            document.getElementById('intro-status').innerText = "_AUDIO_ENABLED_";
        });

        // Modified: fetchData now accepts parameters and a renderMode
        // renderMode: 'auto' (default, handles routing) | 'manual' (just updates data)
        async function fetchData(queryParams = {}, renderMode = 'auto') {
            try {
                const apiParams = new URLSearchParams();

                // Map 'id' to 'product_id'
                if (queryParams.id) {
                    apiParams.append('id', queryParams.id);
                }
                // Map 'cat' to 'major_category'
                if (queryParams.cat) {
                    apiParams.append('cat', queryParams.cat);
                }
                // Map 'q' to 'product_name'
                if (queryParams.q) {
                    apiParams.append('q', queryParams.q);
                }

                const baseUrl = 'https://product.cyberspacee.workers.dev';
                const queryString = apiParams.toString();
                const fetchUrl = queryString ? `${baseUrl}?${queryString}` : baseUrl;

                // Explicitly use the requested URL with params
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error("JSON Fetch Failed");
                const jsonData = await response.json();
                const processed = jsonData.data.map(item => {
                    const prices = item.variations.map(v => v.price);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const displayPrice = minPrice === maxPrice
                        ? `NT$ ${minPrice.toLocaleString()}`
                        : `NT$ ${minPrice.toLocaleString()} - ${maxPrice.toLocaleString()}`;

                    return {
                        product_id: item.product_id,
                        product_name: item.product_name,
                        category_main: item.brand,
                        category_sub: item.major_category,
                        numericPrice: minPrice,
                        displayPrice: displayPrice,
                        primaryImage: item.images[0],
                        secondImage: item.images[1] || item.images[0],
                        originalPrice: null,
                        images: item.images,
                        variations: item.variations.map(v => ({
                            variation_name: v.variation_name || 'å–®ä¸€æ¬¾å¼',
                            price: v.price,
                            stock: v.stock,
                            variation_images: v.variation_images
                        })),
                        marketing_copy: item.marketing_copy || '',
                        tags: item.tags || [],
                        brand: item.brand || [],
                    };
                });
                
                allProducts = processed.sort((a, b) => b.product_id.localeCompare(a.product_id));
                // Note: categoryData logic removed as we use BRAND_CONFIG

                // --- Mode Check ---
                // If manual mode, we stop here (let the caller handle UI)
                if (renderMode === 'manual') return;

                // --- NEW: URL Parameter Handling Logic (Auto Mode) ---
                // 1. Initialize Nav links regardless of view
                renderNavigationLinks(); // Uses BRAND_CONFIG

                // 2. Use passed queryParams for Routing Logic
                const paramId = queryParams.id; 
                const paramCat = queryParams.cat;
                const paramQ = queryParams.q;

                // 3. Routing Logic
                if (paramId) {
                    // CASE: ID Search -> Detail View
                    const targetProduct = allProducts.find(p => p.product_id === paramId);
                    if (targetProduct) {
                        // Setup basic UI
                        initApp(false); // false means don't force render landing page
                        // Hide landing explicitly
                        document.getElementById('landing-view').classList.add('hidden');
                        // Show detail
                        showProductDetail(paramId);
                    } else {
                        console.warn('Product ID not found, redirecting to home.');
                        initApp();
                    }
                } else if (paramCat || paramQ) {
                    // CASE: Category or Keyword Search -> Grid View
                    initApp(false);
                    document.getElementById('landing-view').classList.add('hidden');
                    document.getElementById('product-detail-view').classList.add('hidden');
                    document.getElementById('product-grid-container').classList.remove('hidden');

                    let filteredResults = allProducts;
                    let titleText = "SEARCH RESULTS";

                    if (paramCat) {
                        filteredResults = filteredResults.filter(p => p.category_sub.includes(paramCat));
                        titleText = `CATEGORY: ${paramCat}`;
                    }
                    
                    if (paramQ) {
                        const lowerQ = paramQ.toLowerCase();
                        filteredResults = filteredResults.filter(p => p.product_name.toLowerCase().includes(lowerQ));
                        titleText = `SEARCH: "${paramQ}"`;
                    }

                    const mainTitle = document.getElementById('main-title');
                    if(mainTitle) {
                        mainTitle.textContent = titleText;
                        mainTitle.classList.remove('hidden');
                    }

                    if (filteredResults.length === 0) {
                        document.getElementById('empty-state').classList.remove('hidden');
                        document.getElementById('product-grid').innerHTML = '';
                    } else {
                        renderProducts(filteredResults);
                    }
                } else {
                    // CASE: No Params -> Default Landing Page
                    initApp();
                }

            } catch (err) {
                console.warn("Fetch Error:", err);
                alert("System Error: Unable to fetch data.");
            }
        }

        // ==========================================
        // PART 3: CART SYSTEM & CHECKOUT (GOOGLE FORM)
        // ==========================================

        let cart = [];

        function initCart() {
            const cartToggle = document.getElementById('cart-toggle');
            const closeCart = document.getElementById('close-cart');
            const cartOverlay = document.getElementById('cart-overlay');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (cartToggle) cartToggle.addEventListener('click', toggleCart);
            if (closeCart) closeCart.addEventListener('click', toggleCart);
            if (cartOverlay) cartOverlay.addEventListener('click', toggleCart);
            if (checkoutBtn) checkoutBtn.addEventListener('click', processCheckout);
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('cart-overlay');
            const isClosed = sidebar.classList.contains('translate-x-full');

            if (isClosed) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                playBleep('C6', '32n');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function addToCartHandler(productId, variationName, price) {
            const product = allProducts.find(p => p.product_id === productId);
            if (!product) return;

            // ä¿®æ­£ï¼šæ ¹æ“šé¸æ“‡çš„æ¬¾å¼åç¨±ï¼Œå°‹æ‰¾å°æ‡‰çš„åœ–ç‰‡
            let displayImage = product.primaryImage; // é è¨­ç‚ºä¸»åœ–

            if (variationName && variationName !== 'å–®ä¸€æ¬¾å¼') {
                const selectedVariation = product.variations.find(v => v.variation_name === variationName);
                // æª¢æŸ¥è©²è®Šé«”æ˜¯å¦æœ‰åœ–ç‰‡
                if (selectedVariation && selectedVariation.variation_images && selectedVariation.variation_images.length > 0) {
                    const varImgData = selectedVariation.variation_images[0];
                    // è™•ç†å­—ä¸²æˆ–ç‰©ä»¶æ ¼å¼çš„åœ–ç‰‡è³‡æ–™
                    if (typeof varImgData === 'string') {
                        displayImage = varImgData;
                    } else if (varImgData && varImgData.option_image_url) {
                        displayImage = varImgData.option_image_url;
                    }
                }
            }

            const cartItem = {
                id: productId + '-' + variationName,
                productId: productId,
                name: product.product_name,
                image: displayImage, // ä½¿ç”¨åˆ¤æ–·å¾Œçš„åœ–ç‰‡
                variation: variationName || 'å–®ä¸€æ¬¾å¼',
                price: price,
                qty: 1
            };

            const existingItem = cart.find(item => item.id === cartItem.id);
            if (existingItem) {
                existingItem.qty++;
            } else {
                cart.push(cartItem);
            }

            updateCartUI();
            toggleCart();
            playSuccessArpeggio();
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items-container');
            const countSpan = document.getElementById('cart-count');
            const totalSpan = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            let totalQty = 0;
            let totalPrice = 0;

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 font-mono text-sm mt-10">
                        :: NULL_DATA ::<br>è³¼ç‰©è»Šæ˜¯ç©ºçš„
                    </div>
                `;
                checkoutBtn.disabled = true;
            } else {
                container.innerHTML = '';
                checkoutBtn.disabled = false;

                cart.forEach((item) => {
                    totalQty += item.qty;
                    totalPrice += item.price * item.qty;

                    const itemHTML = `
                        <div class="flex gap-4 items-start font-mono border-b border-dashed border-gray-300 pb-4 last:border-0">
                            <img src="${item.image}" class="w-16 h-16 object-cover border border-gray-300">
                            <div class="flex-1">
                                <div class="text-xs text-gray-500 mb-1 leading-none tracking-tighter">${item.productId}</div>
                                <h4 class="text-sm font-bold text-black leading-tight mb-1 line-clamp-2">${item.name}</h4>
                                <div class="text-xs text-red-600 mb-2 font-bold">[ ${item.variation} ]</div>
                                <div class="flex justify-between items-center">
                                    <span class="font-bold">NT$ ${item.price}</span>
                                    <div class="flex items-center border border-black">
                                        <button class="px-2 hover:bg-black hover:text-white transition" onclick="changeQty('${item.id}', -1)">-</button>
                                        <span class="px-2 text-sm min-w-[20px] text-center">${item.qty}</span>
                                        <button class="px-2 hover:bg-black hover:text-white transition" onclick="changeQty('${item.id}', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += itemHTML;
                });
            }

            countSpan.textContent = totalQty;
            totalSpan.textContent = `NT$ ${totalPrice.toLocaleString()}`;
        }

        window.changeQty = function (itemId, delta) {
            const item = cart.find(i => i.id === itemId);
            if (!item) return;

            item.qty += delta;
            if (item.qty <= 0) {
                cart = cart.filter(i => i.id !== itemId);
            }
            updateCartUI();
            playBleep('A4', '64n');
        }

        // --- NEW CHECKOUT LOGIC FOR GOOGLE FORM ---
        function processCheckout() {
            if (cart.length === 0) return;

            // 1. Generate Order Text
            let orderText = `ã€ SAMANTHA | è¨‚å–®è«‹æ±‚ ã€‘\n`;
            orderText += `--------------------------------\n`;
            cart.forEach(item => {
                orderText += `â–  ${item.name}\n`;
                orderText += `  è¦æ ¼: ${item.variation} x ${item.qty}\n`;
                orderText += `  å°è¨ˆ: $${item.price * item.qty}\n`;
                orderText += `--------------------------------\n`;
            });
            const totalPrice = document.getElementById('cart-total').textContent;
            orderText += `\nğŸ’° ç¸½é‡‘é¡: ${totalPrice}\n`;
            orderText += `ğŸ•’ æ™‚é–“: ${new Date().toLocaleString()}`;

            // 2. Encode for URL
            const encodedOrderText = encodeURIComponent(orderText);

            // 3. Construct URL
            // Check if user has updated the placeholder
            if (GOOGLE_FORM_URL.includes("YOUR_FORM_ID")) {
                alert("ç³»çµ±éŒ¯èª¤ï¼šå°šæœªè¨­å®š Google è¡¨å–®é€£çµã€‚\nè«‹ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ GOOGLE_FORM_URLã€‚");
                return;
            }

            const finalUrl = `${GOOGLE_FORM_URL}?usp=pp_url&${ORDER_FIELD_ID}=${encodedOrderText}`;

            // 4. Redirect
            const conf = confirm("å³å°‡è·³è½‰è‡³è¨‚å–®ç¢ºèªè¡¨å–®ã€‚\n\nç³»çµ±å·²è‡ªå‹•å¡«å¯«è³¼ç‰©è»Šå…§å®¹ï¼Œè«‹è£œå……æ‚¨çš„è¯çµ¡è³‡è¨Šä»¥åˆ©æˆ‘å€‘å¯„é€è³£å ´é€£çµã€‚");
            if (conf) {
                window.open(finalUrl, '_blank');
                cart = [];
                updateCartUI();
                toggleCart();
            }
        }

        // ==========================================
        // PART 4: APP LOGIC
        // ==========================================

        function initApp(renderLanding = true) {
            const logContainer = document.getElementById('system-log-container');
            if (logContainer) {
                logContainer.innerHTML = `
                    <div class="log-item"><span class="log-date">2025.11.30</span><span class="log-category">[ N E W ]</span><span class="log-content">å…§è¤²å…”è»Šé•·åŠé£¾æ•¸æ“šè¼‰å…¥å®Œæˆã€‚</span></div>
                    <div class="log-item"><span class="log-date">2025.11.28</span><span class="log-category">[ UPDATE ]</span><span class="log-content">ç³»çµ± Ver 1.0.3 ä¸Šç·šï¼Œå„ªåŒ–åœ–åƒæ¿¾æ³¢ã€‚</span></div>
                    <div class="log-item"><span class="log-date">2025.11.25</span><span class="log-category">[ CHI I KAWA ]</span><span class="log-content">å‰ä¼Šå¡å“‡ä¼è¦‹ç¨»è·ç³»åˆ—å…¥åº«ã€‚</span></div>
                `;
            }

            if (renderLanding) {
                renderLandingPage(); // Now uses global configs
            }

            // New Menu Logic for Overlay
            const menuToggle = document.getElementById('menu-toggle');
            const navOverlay = document.getElementById('nav-overlay');
            const closeNavBtn = document.getElementById('close-nav-btn');

            if (menuToggle && navOverlay && closeNavBtn) {
                menuToggle.addEventListener('click', () => {
                    navOverlay.classList.add('active');
                    playBleep('C6', '32n');
                });
                closeNavBtn.addEventListener('click', () => {
                    navOverlay.classList.remove('active');
                    playBleep('G5', '32n');
                });
            }

            const backToGrid = document.getElementById('back-to-grid');
            if (backToGrid) backToGrid.addEventListener('click', () => {
                showProductGrid('all');
            });

            const addToCartBtn = document.querySelector('.add-to-cart');
            if (addToCartBtn) {
                addToCartBtn.onclick = function () {
                    const btn = this;
                    const currentId = document.getElementById('product_id') ? document.getElementById('product_id').textContent : null;
                    if (!currentId) return;
                    const selectedVarBtn = document.querySelector('.variation-button.ring-accent-color');
                    let selectedVarName = "é è¨­";
                    let selectedPrice = 0;
                    const product = allProducts.find(p => p.product_id === currentId);
                    if (!product) return;
                    if (selectedVarBtn) {
                        const btnText = selectedVarBtn.textContent;
                        selectedVarName = btnText.split(' (NT$')[0];
                        const variant = product.variations.find(v => v.variation_name === selectedVarName);
                        selectedPrice = variant ? variant.price : product.numericPrice;
                    } else {
                        if (product.variations.length > 0 && product.variations[0].variation_name !== 'å–®ä¸€æ¬¾å¼') {
                            alert("è«‹å…ˆé¸æ“‡æ¬¾å¼ // SELECT_VARIATION");
                            return;
                        }
                        selectedVarName = "å–®ä¸€æ¬¾å¼";
                        selectedPrice = product.numericPrice;
                    }
                    if (!btn.classList.contains('animate-pulse')) {
                        btn.classList.add('animate-pulse');
                        setTimeout(() => btn.classList.remove('animate-pulse'), 900);
                    }
                    addToCartHandler(currentId, selectedVarName, selectedPrice);
                };
            }

            const tooltip = document.getElementById('cursor-tooltip');
            document.addEventListener('mousemove', (e) => {
                tooltip.style.left = e.clientX + 'px';
                tooltip.style.top = e.clientY + 'px';
            });
            document.body.addEventListener('mouseover', (e) => {
                const card = e.target.closest('.product-card');
                if (card) {
                    tooltip.style.opacity = '1';
                } else {
                    tooltip.style.opacity = '0';
                }
            });
            initCart();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial load: parse window URL parameters and pass to fetchData
            const urlParams = new URLSearchParams(window.location.search);
            const initialParams = {
                id: urlParams.get('id'),
                cat: urlParams.get('cat'),
                q: urlParams.get('q')
            };
            fetchData(initialParams);
        });

        window.addEventListener('resize', () => {
            resizeAnimation();
            if (currentState !== STATE.END) initAnimation();
        });

        function renderNavigationLinks() {
            const navLinksContainer = document.getElementById('nav-links-container');
            if (!navLinksContainer) return;
            navLinksContainer.innerHTML = '';

            // Add Home Link
            const homeLink = document.createElement('a');
            homeLink.href = 'index.html'; 
            homeLink.textContent = "00 // HOME_BASE";
            homeLink.onclick = (e) => {
                e.preventDefault();
                playBleep('G4', '64n');
                window.location.href = window.location.pathname; // Clear query params
            };
            navLinksContainer.appendChild(homeLink);

            // Extract unique brands from BRAND_CONFIG
            const uniqueBrands = [...new Set(BRAND_CONFIG.map(item => item.brand))];

            let counter = 1;
            uniqueBrands.forEach(brand => {
                const link = document.createElement('a');
                link.href = '#';
                const num = counter < 10 ? `0${counter}` : counter;
                
                // Display simplification: "å…§è¤²å…” (Opanchu)" -> "å…§è¤²å…”" for menu if desired, 
                // but keeping full name is safer for matching.
                link.textContent = `${num} // ${brand}`;
                
                link.onclick = (e) => {
                    e.preventDefault();
                    playBleep('G4', '64n');
                    showProductGrid(brand);
                    document.getElementById('nav-overlay').classList.remove('active');
                };
                navLinksContainer.appendChild(link);
                counter++;
            });
        }
        // ==========================================
        // ARTWORK DATABASE
        // ==========================================
     const artworks = [
            {
                id: "ERR_01",
                title: "The Compiler's Blue Hour / ç·¨è­¯è€…çš„è—è‰²æ™‚åˆ»",
                src: "p5_4.html", // æ‚¨çš„ç¬¬ä¸€å€‹ p5 ä½œå“æª”æ¡ˆ
                desc: "ä½œå“ç†å¿µï¼šé€™æ˜¯ä¸€ä»¶æ¢ç´¢ ã€Œç‰©ç†ç©ºé–“ã€ç¨‹å¼é‚è¼¯èˆ‡å¿ƒç†ç‹€æ…‹ã€ ç›¸äº’æ»²é€çš„äº’å‹•è—è¡“ä½œå“ã€‚éˆæ„Ÿæºè‡ªå°åŒ—ä¸€æ£Ÿ 1961 å¹´çš„è€å»ºç¯‰â€”â€”è¬æ–‡å ‚å¤§æ¨“ã€‚åœ¨é‚£è£¡ï¼ŒèˆŠæ™‚ä»£çš„æ°´æ³¥è³ªæ„Ÿèˆ‡ç¾ä»£çš„ç²¾å“å’–å•¡ä¸¦å­˜ï¼›å°±åƒç¨‹å¼ç¢¼ä¸­ï¼ŒLegacy Code èˆ‡æ–°ç®—æ³•çš„æŒçºŒå°è©±ã€‚ä½œå“è©¦åœ–æ•æ‰ç¨‹å¼è¨­è¨ˆå¸«ï¼ˆCoderï¼‰ç¨æœ‰çš„å…©ç¨®å¿ƒç†æ™‚å€ï¼šDay Mode (ç·¨è­¯æ¨¡å¼)ï¼š ç†æ€§ã€æ¥µç°¡ã€å°ˆæ³¨çš„é«˜å°æ¯”ç‹€æ…‹ã€‚Blue Hour (è—è‰²æ™‚åˆ»)ï¼š ç•¶å¤ªé™½è½ä¸‹ã€ç¨‹å¼ç¢¼æš«åœï¼Œæ€ç·’éš¨è‘— Nosaj Thing çš„é›»å­æ°›åœæ¨‚æµå‹•ï¼Œæ„Ÿæ€§èˆ‡æ•…éšœï¼ˆGlitchï¼‰ä¸¦å­˜çš„æ™‚åˆ»ã€‚",
                meta: "> SYSTEM_ANALYSIS:\n> ENTROPY_LEVEL: 98%\n> RENDER_TIME: REALTIME"
            },
            {
                id: "ERR_02",
                title: "Kyoto Data Breath: Concrete & Resonance (äº¬éƒ½æ•¸æ“šä¹‹æ¯ï¼šæ¸…æ°´æ¨¡èˆ‡å…±é³´)",
                src: "p5.html", // æ‚¨çš„ç¬¬ä¸€å€‹ p5 ä½œå“æª”æ¡ˆ
                desc: "ä½œå“ç†å¿µï¼š æœ¬ä½œæ˜¯ä¸€ä»¶æ¢è¨ã€Œç†æ€§æ¡†æ¶èˆ‡æ„Ÿæ€§æµå‹•ã€çš„ç”Ÿæˆå¼è—è¡“ï¼ˆGenerative Artï¼‰ä½œå“ã€‚éˆæ„Ÿæºè‡ªå†°å³¶ä½œæ›²å®¶ JÃ³hann JÃ³hannsson çš„æ¥µç°¡ä¸»ç¾©éŸ³æ¨‚ï¼Œä»¥åŠäº¬éƒ½é¾å®‰å¯ºçš„æ¯å±±æ°´ç¾å­¸ã€‚åœ¨è¦–è¦ºèªè¨€ä¸Šï¼Œæˆ‘æ¨æ£„äº†å‚³çµ±çš„å’Œé¢¨æš–è‰²ï¼Œè½‰è€Œæ¡ç”¨ç•¶ä»£å»ºç¯‰å¤§å¸«å®‰è—¤å¿ é›„æˆ–æ™‚å°šè¨­è¨ˆå¸« Rick Owens ç­†ä¸‹çš„ã€Œå†·ç°éšï¼ˆGreigeï¼‰ã€è‰²èª¿ã€‚èƒŒæ™¯æ¨¡æ“¬ä¹¾ç‡¥æ¸…æ°´æ¨¡ï¼ˆDry Concreteï¼‰çš„è³ªæ„Ÿï¼Œéš¨è‘—ç¨‹å¼é‹è¡Œçš„æ™‚é–“è»¸ï¼Œç‰†é¢æœƒç·©æ…¢åœ°æµ®ç¾æ°´æ¼¬èˆ‡é¢¨åŒ–ç—•è·¡ï¼Œå±•ç¾æ•¸ä½ä¸–ç•Œä¸­çš„ã€Œæ™‚é–“é½è•ã€ã€‚è¦–è¦ºæ§‹æˆï¼šéœæ­¢çš„éŒ¨é»ï¼ˆThe Anchorsï¼‰ï¼š ç•«é¢ä¸­æ•£è½çš„å¢¨è‰²å·¨çŸ³ï¼Œç”±é›™å±¤é›œè¨Šæ¼”ç®—æ³•ç”Ÿæˆï¼Œæ¨¡æ“¬è‡ªç„¶ç•Œä¸­éè¦å¾‹çš„ç²—ç³™è¼ªå»“ã€‚å®ƒå€‘è±¡å¾µè‘—ã€Œä¸è®Šã€ï¼Œå¦‚åŒæ·±æµ·ä¸­çš„é»‘è‰²ç¢‘çŸ³ï¼Œéœéœæ‰¿è¼‰è‘—æ­²æœˆã€‚æµå‹•çš„è„ˆæï¼ˆThe Pulseï¼‰ï¼š ç©¿æ¢­æ–¼å·¨çŸ³åº•éƒ¨çš„ï¼Œæ˜¯å››æ¢è±¡å¾µå¼¦æ¨‚å››é‡å¥çš„æ•¸æ“šæ³¢æµªã€‚å®ƒå€‘ä»¥å‚³çµ±æ—¥æœ¬è‰²â€”â€”èŒœè‰²ï¼ˆAkane Redï¼‰èˆ‡è‹”è‰²ï¼ˆKoke Greenï¼‰å‘ˆç¾ï¼Œåœ¨å†·å†½çš„ç°è‰²ç©ºé–“ä¸­ï¼Œå¦‚è¡€æ¶²èˆ¬å¾®å¼±å»é ‘å¼·åœ°æå‹•ã€‚äº’å‹•èˆ‡é«”é©—ï¼š è§€è€…é€éæ¸¸æ¨™çš„ä»‹å…¥ï¼Œå¦‚åŒåœ¨å¯§éœçš„æ°´é¢è¼•è¼•æ’¥å‹•ç´å¼¦ã€‚æ•¸æ“šç²’å­æœƒå› æ­¤ç”¢ç”Ÿæ“¾å‹•èˆ‡å…±é³´ï¼Œéš¨å¾Œåˆåœ¨æ¼”ç®—æ³•çš„å¼•å°ä¸‹å›æ­¸å¹³éœã€‚é€™ä¸åƒ…æ˜¯è¦–è¦ºçš„å‘ˆç¾ï¼Œæ›´æ˜¯ä¸€å ´é—œæ–¼ã€Œå‘¼å¸ã€æ•¸æ“šèˆ‡å­¤å¯‚æ„Ÿã€çš„æ•¸ä½å†¥æƒ³ã€‚",
                meta: "> SYSTEM_ANALYSIS:\n> ENTROPY_LEVEL: 98%\n> RENDER_TIME: REALTIME"
            },
            {
                id: "ERR_03",
                title: "Flight from the Cityï¼šé‡‘è‰²æ˜‡è¯",
                src: "p5_2.html", // å‡è¨­æ‚¨æœ‰ç¬¬äºŒå€‹ä½œå“ï¼Œè‹¥ç„¡å¯å…ˆå¡« p5.html æ¸¬è©¦
                desc: "æœ¬ä½œæ˜¯å° JÃ³hann JÃ³hannsson æ¨‚æ›²ã€ŠFlight from the Cityã€‹çš„è¦–è¦ºè½‰è­¯ã€‚æ¨‚æ›²ä¸­é‡è¤‡è€Œæ¥µç°¡çš„é‹¼ç´è²ï¼Œå½·å½¿æ˜¯ä¸€ç¨®å„€å¼ï¼Œå°‡æ²ˆé‡çš„ç¾å¯¦å±¤å±¤å‰é›¢ã€‚è¦–è¦ºä¸Šï¼Œæˆ‘æ§‹å»ºäº†ä¸€å€‹æ¥µç°¡çš„å†¥æƒ³ç©ºé–“ã€‚èƒŒæ™¯è‰²å–è‡ªäº¬éƒ½çš„ã€Œéšœå­ (Shoji)ã€â€”â€”é‚£æ˜¯é€è‘—å…‰çš„ç±³ç™½å’Œç´™è‰²ï¼ˆ#F9F7F2ï¼‰ï¼Œè±¡å¾µè‘—ç•™ç™½èˆ‡å¯§éœã€‚æ•¸ç™¾å€‹é‡‘è‰²çš„ç²’å­ä¸¦éè¢«é‡åŠ›æŸç¸›ï¼Œè€Œæ˜¯æ“æœ‰ã€Œåé‡åŠ›ã€çš„ç‰©ç†å±¬æ€§ã€‚ç¨‹å¼ç¢¼é€é Perlin Noiseï¼ˆæŸæ—é›œè¨Šï¼‰æ¨¡æ“¬äº†çœ‹ä¸è¦‹çš„ç†±æ°£æµï¼Œé©…å‹•é€™äº›ä»£è¡¨ã€Œè¨˜æ†¶ç¢ç‰‡ã€çš„ç²’å­ç·©æ…¢èœ¿èœ’ä¸Šå‡ã€‚å®ƒå€‘ä¾ç…§æ­£å¼¦æ³¢ï¼ˆSine Waveï¼‰çš„é »ç‡å‘¼å¸é–ƒçˆï¼Œå¦‚åŒé‹¼ç´éµç›¤è¢«è¼•è¼•æ•²æ“Šçš„ç¯€å¥ã€‚é€™æ˜¯ä¸€å€‹é—œæ–¼ã€Œé‡‹æ”¾ã€çš„éç¨‹ï¼šç•¶è¨˜æ†¶ä¸å†æ²‰é‡ï¼Œä¾¿åŒ–ä½œé‡‘è‰²çš„å¾®å¡µï¼Œè¼•ç›ˆåœ°é£›é›¢åŸå¸‚ï¼Œæ¶ˆèåœ¨å…‰çš„å½¼ç«¯ã€‚",
                meta: "> SYSTEM_ANALYSIS:\n> STACK_OVERFLOW: TRUE\n> DEPTH: INFINITE"
            },
            {
                id: "ERR_04",
                title: "Good Night, Dayï¼šå…‰çš„æ²‰ç©",
                src: "p5_3.html", // ç¬¬ä¸‰å€‹ä½œå“
                desc: "JÃ³hann JÃ³hannsson çš„ã€ŠGood Night, Dayã€‹ï¼Œ æˆ‘çœ‹è¦‹çš„ä¸æ˜¯å¤œæ™šçš„é»‘æš—ï¼Œè€Œæ˜¯å…‰çš„é‡é‡ã€‚åœ¨é€™å€‹åç‚ºã€ŒGOOD NIGHTã€çš„ç¨‹å¼è£¡ï¼Œ æˆ‘å¯«ä¸‹äº†é‡åŠ›ï¼Œä½†æ‹¿æ‰äº†æ¶ˆå¤±çš„æŒ‡ä»¤ã€‚ æ¯ä¸€å€‹ç²’å­éƒ½æ˜¯ä»Šå¤©çš„ä¸€å€‹å¿µé ­ï¼Œ å®ƒå€‘ç©¿éåˆå¤œè—çš„æ·±ç©ºï¼Œ æ…¢æ…¢åœ°ã€å®‰éœåœ°ï¼Œé™è½åœ¨åœ°å¹³ç·šä¸Šã€‚å®ƒå€‘æ²’æœ‰æ¶ˆå¤±ï¼Œè€Œæ˜¯å †ç©æˆäº†ä¸€å±¤æº«æš–çš„ç¥ç€è‰²ã€‚ ç„¦æ…®å¡µåŸƒè½å®šï¼Œè®Šæˆäº†å…‰ã€‚",
                meta: "> SYSTEM_ANALYSIS:\n> WAVE_FORM: RANDOM\n> FLUID_SIM: ACTIVE"
            }
        ];
        let currentArtIndex = 0;

        function showWorkView() {
            playBleep('F#2', '16n'); // Glitchy sound
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('product-grid-container').classList.add('hidden');
            document.getElementById('product-detail-view').classList.add('hidden');
             
            const workView = document.getElementById('work-view');
            if(workView) {
                workView.classList.remove('hidden');
                // åˆå§‹åŒ–è¼‰å…¥åˆ—è¡¨èˆ‡ç¬¬ä¸€å€‹ä½œå“
                renderArtworkList();
                loadArtwork(0); 
            }
             
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                mainTitle.classList.add('hidden');
            }
        }
        function renderArtworkList() {
            const listContainer = document.getElementById('art-file-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';

            artworks.forEach((art, index) => {
                const isActive = index === currentArtIndex;
                const btn = document.createElement('button');
                 
                // Style calculation
                let baseClass = "text-left font-mono text-xs py-2 px-3 border border-transparent hover:border-black hover:bg-white hover:text-black transition flex justify-between items-center group w-full";
                let activeClass = isActive ? "bg-black text-white" : "text-gray-600";
                 
                btn.className = `${baseClass} ${activeClass}`;
                btn.onclick = () => loadArtwork(index);
                 
                // Prefix logic
                let prefixHTML = '';
                if (isActive) {
                    // Active: Blinking cursor >_
                    prefixHTML = `<span class="animate-blink-cursor mr-2">&gt;_</span>`;
                } else {
                    // Inactive: Simple circle
                    prefixHTML = `<span class="mr-2 opacity-50">â—‹</span>`;
                }
                 
                btn.innerHTML = `
                    <span class="flex items-center">
                        ${prefixHTML}
                        <span>${art.id}</span>
                    </span>
                    <span class="opacity-50 group-hover:opacity-100 text-[10px] uppercase tracking-tighter hidden md:inline-block">
                        ${art.title.split('(')[0]}
                    </span>
                `;
                listContainer.appendChild(btn);
            });
        }

        function loadArtwork(index) {
            if (index < 0 || index >= artworks.length) return;
             
            currentArtIndex = index;
            const art = artworks[index];
             
            // 1. æ›´æ–° iframe
            const iframe = document.getElementById('art-frame');
            if (iframe) {
                // åªæœ‰ç•¶ src çœŸçš„æ”¹è®Šæ™‚æ‰é‡æ–°è¼‰å…¥ï¼Œé¿å…é–ƒçˆ
                // ä½†å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ (srcç‚ºç©º) å‰‡å¿…é ˆè¼‰å…¥
                if (!iframe.src.includes(art.src)) {
                    // ç‚ºäº†æ¨¡æ“¬è¼‰å…¥æ„Ÿï¼Œå…ˆé¡¯ç¤º Loadingï¼Œå†è¼‰å…¥ iframe
                    const loadingText = document.getElementById('p5-loading');
                    if(loadingText) loadingText.style.display = 'flex';
                     
                    iframe.src = art.src;
                     
                    iframe.onload = () => {
                        if(loadingText) loadingText.style.display = 'none';
                    };
                }
            }

            // 2. æ›´æ–°æ–‡å­—è³‡è¨Š
            document.getElementById('art-title').textContent = art.title;
            document.getElementById('art-desc').textContent = art.desc;
            document.getElementById('art-meta').innerHTML = art.meta.replace(/\n/g, '<br>');

            // 3. æ›´æ–°åˆ—è¡¨æŒ‰éˆ•ç‹€æ…‹ (é‡ç¹ªåˆ—è¡¨æœ€ç°¡å–®)
            renderArtworkList();
             
            // 4. éŸ³æ•ˆ
            playBleep('A3', '32n');
        }
        function renderLandingPage() {
            const landingIndexContainer = document.getElementById('data-index');
            const previewBg = document.getElementById('index-preview-bg');
            if (!landingIndexContainer) return;

            // æ¸…é™¤é™¤äº† previewBg ä»¥å¤–çš„å…§å®¹
            // å…ˆä¿ç•™ previewBg å…ƒç´ 
            const bgElement = landingIndexContainer.querySelector('#index-preview-bg');
            landingIndexContainer.innerHTML = '';
            if (bgElement) landingIndexContainer.appendChild(bgElement);

            // Filter brands based on FEATURED_BRANDS
            const categoriesToRender = FEATURED_BRANDS;

            categoriesToRender.forEach((mainCategory, index) => {
                // Try to find a cover image from loaded products, fallback if not found
                const firstProduct = allProducts.find(p => p.category_main === mainCategory && p.category_sub === "ç©å¶/ç©å…·");
                const coverImage = firstProduct ? firstProduct.primaryImage : 'https://placehold.co/800x600/BBBBBB/333333?text=Category';

                // Status Logic (Random for now)
                const statuses = ["HOT", "NEW", "RESTOCK", "LOW_STOCK"];
                const status = statuses[index % statuses.length];

                const itemDiv = document.createElement('div');
                itemDiv.className = 'index-item';
                itemDiv.dataset.img = coverImage;
                itemDiv.onclick = () => showProductGrid(mainCategory);

                itemDiv.innerHTML = `
                    <span>0${index + 1} . . . . . . ${mainCategory.toUpperCase()}</span>
                    <span class="text-xs">[ STATUS: ${status} ]</span>
                `;

                // Add Hover Events
                itemDiv.addEventListener('mouseenter', () => {
                    const imgUrl = itemDiv.dataset.img;
                    if (previewBg) {
                        previewBg.src = imgUrl;
                        previewBg.style.opacity = '0.15'; // åœ–ç‰‡æ·¡æ·¡æµ®ç¾
                        playBleep('C2', '64n'); // Low pitch sound
                    }
                });

                itemDiv.addEventListener('mouseleave', () => {
                    if (previewBg) previewBg.style.opacity = '0';
                });

                landingIndexContainer.appendChild(itemDiv);
            });
            // --- INSERT NEW ART ITEM HERE ---
            const artIndex = categoriesToRender.length + 1; // e.g. 03
            const num = artIndex < 10 ? `0${artIndex}` : artIndex;

            const artDiv = document.createElement('div');
            artDiv.className = 'index-item';
            // Placeholder image for Art
            artDiv.dataset.img = 'https://placehold.co/800x600/111/FFF?text=SYNTAX_ERROR';
            artDiv.onclick = () => showWorkView(); // New function

            artDiv.innerHTML = `
                <span class="text-[#FF3333] font-bold">${num} . . . . . . [ SYNTAX_ERROR ]</span>
                <span class="text-xs text-[#FF3333]">[ STATUS: CORRUPTED ]</span>
            `;
            // Add Hover Events for Art
            artDiv.addEventListener('mouseenter', () => {
                const imgUrl = artDiv.dataset.img;
                if (previewBg) {
                    previewBg.src = imgUrl;
                    previewBg.style.opacity = '0.15';
                    playBleep('F#2', '32n'); // Glitch sound
                }
            });
            artDiv.addEventListener('mouseleave', () => {
                if (previewBg) previewBg.style.opacity = '0';
            });

            landingIndexContainer.appendChild(artDiv);
        }
 
        function renderProducts(products) {
            const container = document.getElementById('product-grid');
            if (!container) return;
            let htmlContent = '';
            products.forEach(product => {
                const dataDeco = generateDataDecoration(product.product_id);
                const productHTML = `
                    <div class="product-card text-center cursor-pointer" data-product-id="${product.product_id}">
                        <a href="#" class="product-link block" 
                           onclick="event.preventDefault(); showProductDetail('${product.product_id}');"
                           onmouseover="this.querySelector('img').src = '${product.secondImage}'"
                           onmouseout="this.querySelector('img').src = '${product.primaryImage}'">
                            <img src="${product.primaryImage}" alt="${product.product_name}" class="w-full h-auto object-cover mb-4 rounded-lg" loading="lazy">
                        </a>
                        <div class="product-info">
                            <h3 class="product-name text-base font-normal mb-1 uppercase text-black">${product.product_name}</h3>
                            <p class="product-price text-sm font-bold">${product.displayPrice}</p>
                            <p class="data-decoration">${dataDeco}</p>
                        </div>
                    </div>
                `;
                htmlContent += productHTML;
            });
            container.innerHTML = htmlContent;
        }

        function showProductDetail(id) {
            playBleep('D5', '64n');
            const product = allProducts.find(p => p.product_id === id);
            if (!product) return;
            const mainImage = document.getElementById('detail-main-image');
            const productidSpan = document.getElementById('product_id');
            const detailName = document.getElementById('detail-name');
            const priceRange = document.getElementById('detail-price-range');
            const originalPriceElement = document.getElementById('detail-original-price');
            const mainTitle = document.getElementById('main-title');
            const thumbnailsContainer = document.getElementById('detail-thumbnails');
            const variationOptionsContainer = document.getElementById('variation-options');

            if (mainImage) mainImage.src = product.primaryImage;
            if (productidSpan) productidSpan.textContent = product.product_id;
            if (detailName) detailName.textContent = product.product_name;
            if (priceRange) priceRange.textContent = product.displayPrice;
            if (originalPriceElement) {
                if (product.originalPrice) {
                    originalPriceElement.textContent = `NT$ ${product.originalPrice.toLocaleString()}`;
                    originalPriceElement.classList.remove('hidden');
                } else {
                    originalPriceElement.classList.add('hidden');
                }
            }
            if (mainTitle) {
                mainTitle.textContent = product.product_name;
                mainTitle.style.fontFamily = "'Inter', sans-serif";
                mainTitle.style.fontWeight = "900";
                mainTitle.style.fontSize = '2.2rem';
                mainTitle.style.color = '#000';
            }
            if (thumbnailsContainer) {
                thumbnailsContainer.innerHTML = '';
                product.images.forEach((imgUrl, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = imgUrl;
                    thumbnail.className = `w-16 h-16 object-cover border cursor-pointer transition duration-200 rounded-sm ${index === 0 ? 'border-2 border-red-500' : 'border-gray-600'}`;
                    thumbnail.onclick = () => {
                        mainImage.src = imgUrl;
                        playBleep('E5', '64n');
                        document.querySelectorAll('#detail-thumbnails img').forEach(t => t.classList.remove('border-2', 'border-red-500'));
                        thumbnail.classList.add('border-2', 'border-red-500');
                    };
                    thumbnailsContainer.appendChild(thumbnail);
                });
            }
            if (variationOptionsContainer) {
                variationOptionsContainer.innerHTML = '';
                product.variations.forEach((v, index) => {
                    const btn = document.createElement('button');
                    btn.className = `variation-button px-4 py-2 text-sm transition duration-200 rounded-sm bg-black hover:bg-white hover:text-black ${index === 0 ? 'ring-2 ring-accent-color' : ''}`; // é è¨­é¸å–ç¬¬ä¸€å€‹
                    btn.textContent = `${v.variation_name} (NT$ ${v.price})`;
                    btn.onclick = (e) => {
                        playBleep('G5', '64n');
                        // 1. ç§»é™¤å…¶ä»–æŒ‰éˆ•æ¨£å¼
                        document.querySelectorAll('.variation-button').forEach(b => b.classList.remove('ring-2', 'ring-accent-color'));
                        e.target.classList.add('ring-2', 'ring-accent-color');

                        // 2. æ›´æ–°åƒ¹æ ¼é¡¯ç¤ºç‚ºè©²æ¬¾å¼åƒ¹æ ¼
                        if (priceRange) priceRange.textContent = `NT$ ${v.price.toLocaleString()}`;

                        // 3. æ›´æ–°åœ–ç‰‡ (å¦‚æœæœ‰æ¬¾å¼åœ–ç‰‡çš„è©±)
                        if (v.variation_images && v.variation_images.length > 0) {
                            let imgUrl = null;
                            // åˆ¤æ–·åœ–ç‰‡è³‡æ–™çµæ§‹æ˜¯å­—ä¸²é‚„æ˜¯ç‰©ä»¶
                            if (typeof v.variation_images[0] === 'string') {
                                imgUrl = v.variation_images[0];
                            } else if (v.variation_images[0].option_image_url) {
                                imgUrl = v.variation_images[0].option_image_url;
                            }

                            if (imgUrl && mainImage) {
                                mainImage.src = imgUrl;
                                // ç§»é™¤ç¸®åœ–é¸ä¸­ç‹€æ…‹ï¼Œå› ç‚ºç¾åœ¨é¡¯ç¤ºçš„æ˜¯è®Šé«”åœ–
                                document.querySelectorAll('#detail-thumbnails img').forEach(t => t.classList.remove('border-2', 'border-red-500'));
                            }
                        }
                    };
                    variationOptionsContainer.appendChild(btn);
                });
            }
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('product-grid-container').classList.add('hidden');
            // document.getElementById('filter-controls').classList.add('hidden'); // åŸæœ¬çš„é€™è¡Œå¯ä»¥åˆªé™¤ï¼Œå› ç‚º filter-controls å·²ç¶“ä¸å­˜åœ¨äº†
            document.getElementById('product-detail-view').classList.remove('hidden');
        }

        // Updated showProductGrid to reset data source
        async function showProductGrid(mainCategory = 'all') {
            currentZone = mainCategory;
            // æ¯æ¬¡åˆ‡æ›å°ˆå€æ™‚ï¼Œé‡ç½®ç¯©é¸å™¨
            activeFilters = { character: null, type: null };
            updateFilterBtnStyles();
            setupFilterBar(currentZone);

            playBleep('A4', '64n');
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                mainTitle.removeAttribute('style');
                mainTitle.textContent = "ã€ // CURATED ARCHIVE ã€‘";
                mainTitle.style.color = '#000';
            }

            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('product-detail-view').classList.add('hidden');
            document.getElementById('product-grid-container').classList.remove('hidden');
            // Hide Work View
            const workView = document.getElementById('work-view');
            if (workView) workView.classList.add('hidden');

            // --- Updated Logic ---
            // If selecting a specific zone, trigger an initial API search for that brand
            if (currentZone && currentZone !== 'all') {
                const brandKeyword = currentZone.split(' (')[0];
                await fetchData({ q: brandKeyword }, 'manual');
            } else {
                // Reset to full set if 'all'
                await fetchData({}, 'manual');
            }

            // é‡è¦ï¼šåˆ‡æ›åˆ°æ–°çš„ applyFilters
            applyFilters();
        }

        function showLandingPage() {
            document.getElementById('product-grid-container').classList.add('hidden');
            document.getElementById('product-detail-view').classList.add('hidden');
            // Hide Work View
            const workView = document.getElementById('work-view');
            if (workView) workView.classList.add('hidden');

            document.getElementById('landing-view').classList.remove('hidden');
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                mainTitle.removeAttribute('style');
                mainTitle.textContent = "ã€ // CURATED ARCHIVE ã€‘";
                mainTitle.style.color = '#000';
            }
        }
        // 3. è¨­å®šç¯©é¸åˆ—æŒ‰éˆ•
        function setupFilterBar(zoneName) {
            const charRow = document.getElementById('filter-row-character');
            const charBtnGroup = document.getElementById('char-btn-group');

            // æ¸…ç©ºèˆŠæŒ‰éˆ•
            charBtnGroup.innerHTML = '';
            // é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

            if (zoneName === 'ä¸‰éº—é·— (Sanrio)') { // ä¿®æ­£ç‚ºå®Œæ•´çš„å“ç‰Œåç¨±ä»¥åŒ¹é… currentZone
                charRow.classList.remove('hidden');
                // å‹•æ…‹ç”¢ç”Ÿä¸‰éº—é·—è§’è‰²æŒ‰éˆ•
                const chars = ['é…·æ´›ç±³', 'å¤§è€³ç‹—', 'ç¾æ¨‚è’‚', 'Hello Kitty', 'æ¼¢é “', 'å¸•æ°ç‹—'];
                chars.forEach(char => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn px-3 py-1 text-xs rounded-full';
                    btn.textContent = char;
                    btn.onclick = () => toggleFilter('character', char);
                    charBtnGroup.appendChild(btn);
                });
            } else {
                // å…§è¤²å…”ä¸éœ€è¦è§’è‰²ç¯©é¸
                charRow.classList.add('hidden');
            }
        }

        // 4. åˆ‡æ›ç¯©é¸æ¢ä»¶ (Updated to call API)
        async function toggleFilter(category, value) {
            // Toggle Logic
            if (activeFilters[category] === value) {
                activeFilters[category] = null; // å–æ¶ˆ
            } else {
                activeFilters[category] = value; // é¸å–
            }

            updateFilterBtnStyles();

            // 1. Build API Params based on active filters
            const apiQuery = {};
            
            // Build Search Query (q) = [Brand Name] + [Character Name]
            let searchTerms = [];

            // If we are in a specific zone (Brand), always include it in the search 
            if (currentZone && currentZone !== 'all') { 
                searchTerms.push(currentZone);
            }
           
            // Add Character if selected
            if (activeFilters.character) {
                searchTerms.push(activeFilters.character);
            }

            apiQuery.q = searchTerms.join(' ');
            // Build Category Query (cat) = Type
            if (activeFilters.type) {
                // User requirement: 'cat' param finds 'major_category'
                // The buttons pass 'type' (e.g. 'å¨ƒå¨ƒ') which matches major_category
                apiQuery.cat = activeFilters.type;
            }

            // 2. Trigger Fetch in manual mode (don't auto-route)
            // This ensures we get fresh data filtered by the API
            await fetchData(apiQuery, 'manual');
            
            // 3. Ensure View is Correct (Force Grid View if on Landing)
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('product-detail-view').classList.add('hidden');
            document.getElementById('work-view').classList.add('hidden');
            document.getElementById('product-grid-container').classList.remove('hidden');

            // 4. Re-apply client-side Zone filtering (Brand) & Render
            applyFilters();
        }

        // 5. æ›´æ–°æŒ‰éˆ•è¦–è¦º
        function updateFilterBtnStyles() {
            // è™•ç†å‹•æ…‹ç”Ÿæˆçš„è§’è‰²æŒ‰éˆ•
            const charBtns = document.querySelectorAll('#char-btn-group .filter-btn');
            charBtns.forEach(btn => {
                if (btn.textContent === activeFilters.character) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // è™•ç†éœæ…‹çš„é¡å‹æŒ‰éˆ• (æ³¨æ„ï¼šé€™è£¡ç”¨åŒ…å«åŒ¹é…ï¼Œå› ç‚ºæŒ‰éˆ•æ–‡å­—å¯èƒ½æ˜¯ "åŠé£¾/é‘°åŒ™åœˆ")
            const typeBtns = document.querySelectorAll('#filter-row-type .filter-btn');
            typeBtns.forEach(btn => {
                // å–å¾—æŒ‰éˆ•æ ¸å¿ƒé—œéµå­— (å‡è¨­æ˜¯æŒ‰éˆ•æ–‡å­—çš„å‰å…©å€‹å­—ï¼Œæˆ–æ˜¯ç›´æ¥ data-val æ¯”è¼ƒå¥½ï¼Œä½†é€™è£¡ç‚ºäº†ç°¡å–®ç›´æ¥æ¯”å°)
                // ç°¡å–®ä½œæ³•ï¼šå¦‚æœ activeFilters.type ä¸ç‚ºç©ºï¼Œä¸”æŒ‰éˆ•æ–‡å­—åŒ…å«å®ƒ
                if (activeFilters.type && btn.textContent.includes(activeFilters.type)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 6. æ ¸å¿ƒç¯©é¸èˆ‡æ¸²æŸ“
        function applyFilters() {
            // Note: allProducts is now populated by the API call in toggleFilter
            if (!allProducts.length) {
                document.getElementById('product-grid').innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            const grid = document.getElementById('product-grid');
            grid.innerHTML = ''; // Clear

            const filtered = allProducts.filter(p => {
                const tags = p.tags || [];
                const name = p.product_name || "";
                const brand = p.brand || "";
                const cat = p.product_category || "";

                // A. Zone Filter (Hard Filter - Client Side)
                // We handle Brand filtering here because the API query usually handles cross-brand search
                let zoneMatch = (currentZone === 'all') || brand.includes(currentZone);
                if (!zoneMatch) return false;

                // Note: We don't strictly need to re-filter B & C if the API did its job,
                // but keeping them ensures consistency if the API returns loose matches.
                // B. Character Filter
                if (activeFilters.character) {
                    if (!tags.includes(activeFilters.character) && !name.includes(activeFilters.character)) return false;
                }

                // C. Type Filter
                if (activeFilters.type) {
                    const k = activeFilters.type;
                    const typeMatch = tags.some(t => t.includes(k)) || name.includes(k) || cat.includes(k);
                    if (!typeMatch) return false;
                }

                return true;
            });

            if (filtered.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                renderProducts(filtered);
            }
        }

        async function clearSubFilters() {
            activeFilters = { character: null, type: null };
            updateFilterBtnStyles();
            // Reset API fetch to get all data for the zone
            await fetchData({}, 'manual');
            applyFilters();
        }
    </script>
</body>

</html>
