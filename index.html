<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S A M A N T H A | S O F T C O D E</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Space Mono (關鍵字體) & Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <!-- 引入 Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* --- 核心變數：Light Theme (Production Ready) --- */
        :root {
            --base-bg: #FAF9F6;         /* 奶油白/燕麥色 */
            --grid-border: #BBBBBB;     /* 極細灰線 */
            --primary-text: #333333;    /* 深炭灰 */
            --code-comment: #666666;    /* 註解色 */
            --accent: #FF3333;          /* 統一使用警示紅 */
            --accent-dark: #CC0000;     /* 深紅色 */
            --line-black: #111111;      /* 線條動畫專用黑 */
            --line-red: #FF3333;        /* 警示紅 (Glitch/Target) */
        }
        
        /* --- 全站基礎設定 --- */
        body {
            font-family: 'Inter', Arial, sans-serif;
            color: var(--primary-text);
            background-color: var(--base-bg);
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            cursor: crosshair; /* UX: 全站準心游標 */
        }

        /* 自定義游標跟隨文字 (Tooltip) */
        #cursor-tooltip {
            position: fixed;
            pointer-events: none;
            background: var(--line-red);
            color: white;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 2px;
            z-index: 99999;
            opacity: 0;
            transform: translate(15px, 15px);
            transition: opacity 0.1s;
            white-space: nowrap;
        }

        /* --- 1. Intro Animation Layers --- */
        #canvas-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9998;
            pointer-events: none;
            mix-blend-mode: multiply; 
            transition: opacity 1.5s ease-out;
        }

        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(250, 249, 246, 0.4); 
            cursor: pointer;
            transition: opacity 0.5s;
        }

        #intro-text-box {
            transition: opacity 0.8s ease-out;
            opacity: 1;
        }

        #skip-intro {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10000;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--primary-text);
            border: 1px solid var(--primary-text);
            padding: 8px 12px;
            background: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s;
        }
        #skip-intro:hover {
            background: var(--primary-text);
            color: var(--base-bg);
        }

        .blink-text {
            animation: blinker 0.1s steps(2, start) infinite;
            font-family: 'Space Mono', monospace;
            color: var(--line-black); 
            text-transform: uppercase;
            letter-spacing: 2px;
            background: white;
            padding: 5px 10px;
        }
        @keyframes blinker { to { opacity: 0; } }

        /* --- 2. Main Site Wrapper --- */
        #site-wrapper {
            opacity: 0;
            transition: opacity 2s ease-in;
            background-color: var(--base-bg);
            min-height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* --- 3. Styles & Grid --- */
        .ikeda-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0; 
            background: linear-gradient(rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.015) 50%), linear-gradient(90deg, rgba(0, 0, 0, 0.015) 1px, transparent 1px);
            background-size: 100% 2px, 20px 20px;
        }

        #data-ticker-container {
            overflow: hidden;
            background-color: #f5f5f5; 
            border-bottom: 1px solid var(--grid-border);
            padding: 5px 0;
            z-index: 20;
            position: relative;
        }
        #data-ticker {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--code-comment);
            white-space: nowrap;
            display: inline-block;
            padding-left: 100%;
            animation: ticker-flow 18s linear infinite;
        }
        @keyframes ticker-flow { to { transform: translateX(-100%); } }

        .data-barcode-strip {
            width: 100%;
            height: 12px;
            background-color: var(--base-bg);
            overflow: hidden;
            position: relative;
            margin-bottom: 4rem; 
        }
        .data-barcode-strip::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background-image: repeating-linear-gradient(
                90deg,
                rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px,
                transparent 1px, transparent 4px,
                rgba(0,0,0,0.1) 4px, rgba(0,0,0,0.1) 6px,
                transparent 6px, transparent 15px,
                rgba(0,0,0,0.2) 15px, rgba(0,0,0,0.2) 16px, 
                transparent 16px, transparent 25px
            );
            background-size: 25px 100%; 
            animation: data-flow 30s cubic-bezier(0.65, 0, 0.35, 1) infinite,
                       granularity-pulse 8s ease-in-out infinite alternate;
        }
        @keyframes data-flow { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        @keyframes granularity-pulse { 0% { background-size: 25px 100%; } 50% { background-size: 40px 100%; } 100% { background-size: 25px 100%; } }

        .hacker-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            line-height: 1.2;
            gap: 2px;
            cursor: pointer;
        }
        
        .brand-name {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            color: var(--primary-text);
            text-transform: uppercase;
        }
        
        .code-wrapper {
            position: relative;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            color: var(--code-comment);
            letter-spacing: 0.15em;
            padding-bottom: 5px;
        }
        
        .bracket {
            color: var(--primary-text);
            font-weight: 700;
        }
        
        .glitch-underline {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--line-red);
            animation: breathe-line 4s ease-in-out infinite;
            box-shadow: 0 0 5px var(--line-red);
        }
        
        @keyframes breathe-line {
            0%, 100% { opacity: 0.3; transform: scaleX(0.8); }
            50% { opacity: 1; transform: scaleX(1); }
        }
        
        @media (max-width: 640px) {
            .brand-name { font-size: 1.5rem; letter-spacing: 0.15em; }
            .code-wrapper { font-size: 0.75rem; }
        }

        .mobile-logo-break { display: none; }
        @media (max-width: 1023px) { .mobile-logo-break { display: block; content: " "; height: 0; } }

        #main-title {
            font-family: 'Space Mono', monospace;
            font-weight: 400; 
            font-size: 1rem;
            letter-spacing: 0.1em;
            color: var(--code-comment);
            margin-bottom: 5rem; 
            text-transform: none;
        }
        
        .product-name, .category-info h2 {
            font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif !important;
            font-weight: 700;
        }

        #detail-name { 
            font-family: 'Inter', sans-serif; 
            font-weight: 900;
            font-size: 2.2rem; 
            letter-spacing: 0.05em; 
            text-transform: uppercase; 
        }
        .product-price { font-family: 'Space Mono', monospace; color: var(--primary-text); font-weight: bold; }
        
        .data-decoration {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--code-comment);
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }

        .product-grid-container {
            background-color: var(--grid-border); 
            padding: 1px;
            margin: 0 auto;
        }
        .product-grid {
            gap: 1px 1px; 
            background-color: var(--base-bg);
            grid-template-columns: repeat(1, minmax(0, 1fr)); 
        }
        @media (min-width: 640px) { .product-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .product-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        
        .product-card {
            background-color: var(--base-bg);
            padding: 30px;
            transition: none;
            border: 1px solid transparent; 
            position: relative;
        }
        
        .product-card:hover {
            border: 1px solid var(--accent);
        }
        
        .detail-original-price {
            color: var(--code-comment);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            text-decoration: line-through;
            margin-bottom: 0;
            display: block;
        }
        .detail-price {
            font-family: 'Space Mono', monospace;
            font-weight: 800;
        }
        
        .product-card:hover img {
            animation: glitch-anim 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
            filter: contrast(1.1) saturate(0.8);
        }
        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .hidden { display: none !important; }
        
        #nav-links { 
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; 
            background-color: var(--base-bg); 
            border-left: 1px solid var(--grid-border);
        }
        #nav-links a { 
            white-space: normal; 
            color: var(--primary-text);
        }
        #nav-links a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .text-black { color: var(--primary-text) !important; }
        .border-black { border-color: var(--primary-text) !important; }
        .bg-light-purple { background-color: var(--base-bg); }
        
        .add-to-cart { 
            background-color: var(--primary-text); 
            color: white; 
            border: 1px solid var(--primary-text); 
            font-family: 'Space Mono', monospace;
            font-weight: bold;
        }
        .add-to-cart:hover { 
            background-color: var(--accent); 
            border-color: var(--accent); 
            color: white;
        }
        
        .border-accent { border-color: var(--accent) !important; }
        
        .variation-button {
            border: 1px solid var(--grid-border);
            color: var(--primary-text);
            background-color: var(--base-bg);
        }
        .variation-button:not(:disabled):hover { 
            background-color: var(--accent); 
            color: white; 
            border-color: var(--accent); 
        }
        .ring-accent-color { 
            box-shadow: 0 0 0 2px var(--accent); 
            border-color: var(--accent) !important; 
        }

        @keyframes pulse-accent {
            0% { transform: scale(1); background-color: var(--accent); }
            50% { transform: scale(1.05); background-color: var(--accent-dark); }
            100% { transform: scale(1); background-color: var(--accent); }
        }
        .add-to-cart.animate-pulse { animation: pulse-accent 0.3s ease-in-out 3; }

        .filter-controls select {
             font-family: 'Space Mono', monospace;
             border-radius: 0;
             border: 1px solid var(--grid-border);
             color: var(--primary-text);
             background-color: transparent;
             padding: 4px 10px;
        }
        
        .vertical-category-card {
            border: 1px solid var(--grid-border);
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }
        .vertical-category-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }
        .category-image-container img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            margin-bottom: 15px;
            filter: grayscale(20%);
        }
        .vertical-category-card:hover .category-image-container img {
            filter: grayscale(0%);
        }
        .category-info h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-text);
        }
        .category-view-link {
            display: inline-block;
            margin-top: 15px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            text-decoration: underline;
            color: var(--accent);
        }
        
        .log-item {
            border-bottom: 1px solid var(--grid-border);
            padding: 15px 0;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
        }
        .log-date { display: block; color: var(--code-comment); margin-bottom: 4px; }
        .log-category { color: var(--accent); margin-right: 8px; font-weight: bold; }
        .log-content { color: var(--primary-text); }

    </style>
</head>
<body class="min-h-screen">

    <!-- UX: Custom Tooltip -->
    <div id="cursor-tooltip">TARGET ACQUIRED</div>

    <!-- Skip Intro Button -->
    <button id="skip-intro">[ SKIP INTRO ]</button>

    <!-- Phase 0: Intro -->
    <div id="intro-overlay">
        <div id="intro-text-box" class="text-xs tracking-[0.5em] text-black text-center bg-white p-4 border border-black">
            [ SYSTEM INITIALIZING... ]
            <br><br>
            <span class="blink-text" id="intro-status">_LOADING_DATA_</span>
            <br><br>
            <span class="text-gray-500 text-[10px]">( Click to Enable Audio )</span>
        </div>
    </div>
    <canvas id="canvas-layer"></canvas>

    <!-- Phase 1: Main Site -->
    <div id="site-wrapper">

        <div class="ikeda-grid"></div> 
        <header class="border-b border-black py-3 px-4 sm:px-10 sticky top-0 z-50 bg-base-bg/90 backdrop-blur-sm">
            <!-- 修正結構：w-full + justify-between -->
            <nav class="flex justify-between items-center w-full relative h-16">
                <!-- LOGO (永遠在左) - 改用 SVG 圖片引用模式 -->
                <a href="#" class="hacker-logo z-50 flex items-center" onclick="showLandingPage()">
                    <!-- 
                        這裡的 src 使用了 Base64 編碼的 SVG 作為預覽。
                        實際使用時，請將 src 改為您的 SVG 檔案路徑，例如：src="logo.svg"
                        h-10 (約40px) 確保高度固定，w-auto 確保比例自動鎖定
                    -->
                    <img src="logo.svg" 
                         alt="SAMANTHA LOGO" 
                         class="w-auto object-contain" />
                </a>
                
                <!-- 導覽連結 (Sidebar 模式) -->
                <!-- 修正：徹底移除 lg:flex 等桌機設定，讓它永遠是全螢幕 Sidebar 模式 -->
                <div id="nav-links" class="fixed top-0 left-0 w-full h-screen bg-white p-10 transform -translate-x-full transition-transform duration-300 z-40 flex flex-col items-start space-y-6 opacity-0 pointer-events-none">
                    <!-- JS Generated -->
                </div>

                <!-- 右側群組：功能按鈕 (永遠在右) -->
                <div class="flex items-center space-x-4 z-50">
                        <!-- 購物車按鈕 -->
                        <button id="cart-toggle" class="text-xs font-mono uppercase border border-black px-2 py-1 transition duration-200 hover:bg-black hover:text-white text-black flex items-center gap-1">
                            [ CART : <span id="cart-count">0</span> ]
                        </button>
                    <button id="audio-toggle" class="text-xs font-mono uppercase border border-black px-2 py-1 transition duration-200 hover:bg-black hover:text-white text-black">
                        [ AUDIO OFF ]
                    </button>
                    <!-- 漢堡按鈕：移除 lg:hidden，全平台顯示 -->
                    <button id="menu-toggle" class="text-2xl cursor-pointer text-black">☰</button>
                </div>
            </nav>
        </header>

        <div id="data-ticker-container">
            <span id="data-ticker">S Y S T E M &nbsp; O N L I N E &nbsp; . . . &nbsp; C U R A T E D &nbsp; D A T A &nbsp; R E C O R D &nbsp; I N I T I A T E D &nbsp; . . . &nbsp; V E R &nbsp; 1 . 0 . 1 &nbsp; . . . &nbsp; 0 0 1 0 1 1 0 &nbsp; 1 1 0 1 0 0 1 0 1 0 1 0 &nbsp; 0 0 1 1 1 1 0</span>
        </div>

        <div class="data-barcode-strip"></div>
        
        <main class="max-w-7xl mx-auto px-4 sm:px-10 py-12">
            <h1 id="main-title" class="font-normal text-center tracking-widest text-black">【 // CURATED ARCHIVE 】</h1>
            
            <div id="landing-view">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-grow">
                        <h2 class="text-2xl font-mono mb-6 text-black">:: FEATURED COLLECTIONS</h2>
                        <div id="landing-category-grid"></div>
                    </div>
                    <div class="md:w-1/3 mt-8 md:mt-0">
                        <h2 class="text-2xl font-mono mb-6 text-black">:: S Y S T E M _ L O G</h2>
                        <div id="system-log-container">
                            <!-- JS Generated -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="filter-controls" class="hidden flex justify-end gap-6 mb-10 pb-2 border-b border-black">
                <select id="category-main-filter" class="border-none text-sm cursor-pointer outline-none">
                    <option value="all">:: ALL CATEGORIES</option>
                </select>
                <select id="category-sub-filter" class="border-none text-sm cursor-pointer outline-none" disabled>
                    <option value="all">:: ALL SUB-CATEGORIES</option>
                </select>
                <select id="sort-by" class="border-none text-sm cursor-pointer outline-none">
                    <option value="default">SORT :: DEFAULT</option>
                    <option value="price-asc">SORT :: PRICE ASC</option>
                    <option value="price-desc">SORT :: PRICE DESC</option>
                </select>
            </div>

            <div class="product-grid-container hidden" id="product-grid-container">
                <div id="product-grid" class="product-grid grid"></div>
            </div>

            <div id="product-detail-view" class="product-detail-view hidden pt-10">
                <button id="back-to-grid" class="back-button text-sm mb-10 cursor-pointer p-0 border-none bg-transparent text-gray-500 hover:text-black">← 返回產品列表</button>
                <div class="detail-content flex flex-col lg:flex-row lg:space-x-16">
                    <div class="detail-image-container flex-1 mb-8 lg:mb-0">
                        <img id="detail-main-image" src="" alt="產品圖片" class="w-full h-auto object-cover mb-4 rounded-lg border border-gray-200">
                        <div id="detail-thumbnails" class="flex space-x-2 mt-4 overflow-x-auto pb-2"></div>
                    </div>
                    <div class="detail-info flex-1 pt-0 lg:pt-12">
                        <!-- 隱藏的 ID 欄位 -->
                        <span id="product_id" class="hidden"></span>
                        
                        <h2 id="detail-name" class="mb-2 uppercase text-black"></h2>
                        <p id="detail-original-price" class="detail-original-price text-xl font-mono line-through mb-1 hidden"></p>
                        <p class="detail-price text-xl font-extrabold mb-6" id="detail-price-range"></p>
                        <div class="variation-selection mb-10">
                            <h3 class="text-lg font-semibold mb-3 text-black">選擇款式 / 變體:</h3>
                            <div id="variation-options" class="flex flex-wrap gap-3"></div>
                        </div>
                        <div class="detail-description leading-relaxed mb-10 text-gray-700">
                            <p>這是 Samantha 為您精心挑選的療癒小物。每一件產品都充滿溫暖與愛，希望能為您的生活帶來一絲甜美的陪伴和放鬆的氛圍。</p>
                            <ul class="list-none mt-6 space-y-2" style="color: var(--primary-text); font-size: 0.9rem;">
                                <li>主題：甜蜜夢境</li>
                                <li>適用：療癒身心、送禮自用</li>
                                <li>保養：輕柔手洗，自然風乾</li>
                            </ul>
                        </div>
                        <button class="w-full py-4 add-to-cart uppercase text-base transition duration-200">加入購物車</button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- CART DRAWER / SIDEBAR -->
        <div id="cart-overlay" class="fixed inset-0 bg-black/50 z-[9998] hidden backdrop-blur-sm transition-opacity"></div>
        <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-white border-l border-black z-[9999] transform translate-x-full transition-transform duration-300 flex flex-col shadow-2xl">
            <!-- Cart Header -->
            <div class="p-6 border-b border-black flex justify-between items-center bg-gray-50">
                <h2 class="font-mono text-lg font-bold tracking-widest">[ CART_LOG ]</h2>
                <button id="close-cart" class="text-black hover:text-red-600 font-mono text-xl">[X]</button>
            </div>

            <!-- Cart Items Area -->
            <div id="cart-items-container" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- JS 會將商品插入這裡 -->
                <div class="text-center text-gray-400 font-mono text-sm mt-10">
                    :: NULL_DATA ::<br>購物車是空的
                </div>
            </div>

            <!-- Cart Footer / Checkout -->
            <div class="p-6 border-t border-black bg-gray-50">
                <div class="flex justify-between font-mono text-sm mb-4">
                    <span>TOTAL_CALC:</span>
                    <span id="cart-total" class="font-bold">NT$ 0</span>
                </div>
                <!-- 結帳按鈕文字更新 -->
                <button id="checkout-btn" class="w-full py-3 bg-black text-white font-mono hover:bg-[#FF3333] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed uppercase font-bold text-sm tracking-wider">
                    [ SEND TO GOOGLE FORM ]
                </button>
                <p class="text-[10px] text-gray-500 mt-2 font-mono text-center leading-tight">
                    * 點擊後跳轉至訂單表單，請確認資料後提交。
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION (請修改這裡)
        // ==========================================
        // 1. 你的 Google 表單網址 (請換成你的)
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/YOUR_FORM_ID_HERE/viewform";
        
        // 2. 你的「訂單內容」欄位 ID (請換成你的)
        // 在 Google 表單「取得預填連結」中找到 &entry.xxxxxxx=...
        const ORDER_FIELD_ID = "entry.123456789"; 

        // ==========================================
        // PART 1: DATAMATICS PARTICLE ENGINE
        // ==========================================
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const overlay = document.getElementById('intro-overlay');
        const overlayTextBox = document.getElementById('intro-text-box');
        const siteWrapper = document.getElementById('site-wrapper');
        const skipBtn = document.getElementById('skip-intro');

        let width, height;
        let particles = [];
        let targetPixels = [];
        let animationFrameId;
        
        const STATE = { CHAOS: 0, CONVERGE: 1, FORMED: 2, FADEOUT: 3, END: 4 };
        let currentState = STATE.CHAOS;
        let stateTimer = 0;
        let animationSoundPlayed = false;

        function resizeAnimation() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }

        function createTargetPixels() {
            const tempCanvas = document.createElement('canvas');
            const tCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;

            let textLines = [];
            if (width < 768) {
                textLines = ["S A M A N T H A", "S O F T  C O D E"];
            } else {
                textLines = ["S A M A N T H A | S O F T C O D E"];
            }

            const longestLine = textLines.reduce((a, b) => a.length > b.length ? a : b);
            const charCount = longestLine.length;
            const estimatedWidthPerCharRatio = 0.65; 
            const safeFontSize = (width * 0.9) / (charCount * estimatedWidthPerCharRatio);
            const maxFontSize = width < 768 ? 50 : 80; 
            let fontSize = Math.floor(Math.min(maxFontSize, safeFontSize));
            fontSize = Math.max(12, fontSize); 

            tCtx.font = `900 ${fontSize}px "Space Mono", monospace`;
            tCtx.fillStyle = '#000000'; 
            tCtx.textAlign = 'center';
            tCtx.textBaseline = 'middle';

            const lineHeight = fontSize * 1.6; 
            const totalTextHeight = textLines.length * lineHeight;
            const startY = (height - totalTextHeight) / 2 + (lineHeight / 2);

            textLines.forEach((line, index) => {
                tCtx.fillText(line, width / 2, startY + (index * lineHeight) - (lineHeight * 0.2)); 
            });

            const imageData = tCtx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const pixels = [];
            const step = 3; 

            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    if (data[(y * width + x) * 4 + 3] > 128) {
                        pixels.push({ x, y });
                    }
                }
            }
            return pixels;
        }

        class Particle {
            constructor(targetX, targetY) {
                this.targetX = targetX;
                this.targetY = targetY;
                this.x = Math.random() * width; 
                this.y = Math.random() * height; 
                this.w = Math.random() * (width * 0.5) + 50; 
                this.h = Math.random() * 4 + 2; 
                this.vx = (Math.random() - 0.5) * 15; 
                this.vy = 0; 
                
                const rand = Math.random();
                if (rand > 0.7) this.color = '#111111'; 
                else this.color = 'rgba(17, 17, 17, 0.3)'; 
            }

            update() {
                if (currentState === STATE.CHAOS) {
                    this.x += this.vx;
                    if (this.x > width + this.w) this.x = -this.w;
                    if (this.x < -this.w) this.x = width + this.w;
                    if (Math.random() > 0.9) {
                         this.w = Math.random() * (width * 0.8) + 20;
                    }
                } else if (currentState === STATE.CONVERGE) {
                    this.x += (this.targetX - this.x) * 0.1;
                    this.y += (this.targetY - this.y) * 0.1; 
                    this.w += (3 - this.w) * 0.1; 
                    this.h = 3; 
                    if (Math.abs(this.x - this.targetX) < 10) {
                        this.color = '#111111';
                    }
                } else if (currentState === STATE.FORMED) {
                    this.x = this.targetX;
                    this.y = this.targetY;
                    this.w = 3;
                    if (Math.random() > 0.995) {
                        this.w = Math.random() * 50 + 10;
                        this.x = this.targetX - this.w / 2; 
                        this.color = '#FF3333'; 
                    } else {
                        this.color = '#111111';
                    }
                } else if (currentState === STATE.FADEOUT) {
                    this.w += Math.random() * 20; 
                    this.h *= 0.9; 
                    this.x += (Math.random() - 0.5) * 100;
                    this.color = 'rgba(17,17,17,0.1)';
                }
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(Math.floor(this.x), Math.floor(this.y), this.w, this.h);
            }
        }

        function initAnimation() {
            resizeAnimation();
            particles = [];
            targetPixels = createTargetPixels();
            
            const isMobile = width < 768;
            const bgParticleCount = isMobile ? 50 : 200;

            if (targetPixels.length > 0) {
                targetPixels.forEach(p => {
                     particles.push(new Particle(p.x, p.y));
                });
            }
            for(let i=0; i < bgParticleCount; i++) {
                let p = new Particle(width/2, height/2); 
                p.y = Math.random() * height;
                p.w = width; 
                p.h = Math.random() * 1 + 0.5; 
                p.vx = (Math.random() - 0.5) * 2; 
                p.color = 'rgba(17, 17, 17, 0.05)'; 
                p.isBackground = true; 
                particles.push(p);
            }
        }

        function animateLoop() {
            ctx.fillStyle = 'rgba(250, 249, 246, 0.2)'; 
            ctx.fillRect(0, 0, width, height);

            let convergedCount = 0;
            const textParticles = particles.filter(p => !p.isBackground); 
            const totalTargetParticles = textParticles.length;

            particles.forEach(p => {
                if (p.isBackground) {
                    if (currentState === STATE.FADEOUT) {
                        p.h *= 0.9;
                    } else {
                        p.x += p.vx;
                        if (p.x > width) p.x = -width;
                        if (p.x < -width) p.x = width;
                    }
                    p.draw();
                } else {
                    p.update();
                    p.draw();
                    if (currentState === STATE.CONVERGE) {
                        const dist = Math.abs(p.x - p.targetX) + Math.abs(p.y - p.targetY);
                        if (dist < 5) convergedCount++;
                    }
                }
            });

            if (currentState === STATE.CHAOS) {
                stateTimer++;
                if (Math.random() > 0.98) {
                     ctx.fillStyle = 'rgba(17, 17, 17, 0.1)';
                     ctx.fillRect(0, 0, width, height);
                }
                if (stateTimer > 120) currentState = STATE.CONVERGE;
            } else if (currentState === STATE.CONVERGE) {
                if (overlayTextBox && overlayTextBox.style.opacity !== '0') {
                    overlayTextBox.style.opacity = '0';
                }
                if (totalTargetParticles > 0 && convergedCount / totalTargetParticles > 0.8) {
                    if (!animationSoundPlayed && isAudioOn) {
                        playIkedaSnap(); 
                        animationSoundPlayed = true;
                    }
                    currentState = STATE.FORMED;
                    stateTimer = 0;
                }
            } else if (currentState === STATE.FORMED) {
                stateTimer++;
                if (stateTimer > 280) {
                    endIntro();
                }
            }

            if (currentState !== STATE.END) {
                animationFrameId = requestAnimationFrame(animateLoop);
            }
        }

        function endIntro() {
            if (currentState === STATE.END) return;
            currentState = STATE.FADEOUT; 
            overlay.style.opacity = '0';
            skipBtn.style.opacity = '0';
            siteWrapper.style.opacity = '1';
            canvas.style.opacity = '0';
            setTimeout(() => {
                canvas.remove(); 
                overlay.remove();
                skipBtn.remove();
                cancelAnimationFrame(animationFrameId);
                currentState = STATE.END;
            }, 2000);
        }

        // ==========================================
        // PART 2: MAIN SITE LOGIC & AUDIO
        // ==========================================
        
        let synth = null;
        let isAudioOn = false; 
        let masterGain = null;
        let allProducts = []; 
        let categoryData = {}; 
        const featuredCategories = ["內褲兔 (Opanchu)", "三麗鷗 (Sanrio)"]; 

        function playIkedaSnap() {
            if (Tone && Tone.context.state === 'running') {
                const snapSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();
                snapSynth.triggerAttack("C7", Tone.now());
                snapSynth.frequency.rampTo(0, 0.1, Tone.now());
            }
        }

        function playSuccessArpeggio() {
            if (isAudioOn && synth) {
                const now = Tone.now();
                synth.triggerAttackRelease("C5", "32n", now);
                synth.triggerAttackRelease("E5", "32n", now + 0.1);
                synth.triggerAttackRelease("G5", "16n", now + 0.2);
            }
        }

        async function initAudioContext() {
            if (Tone && Tone.context.state !== 'running') {
                await Tone.start();
            }
            if (!synth && Tone) {
                masterGain = new Tone.Gain(0.4).toDestination(); 
                synth = new Tone.Synth({
                    oscillator: { type: "square" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }
                }).connect(masterGain); 
            }
        }

        const audioToggleButton = document.getElementById('audio-toggle');
        if (audioToggleButton) {
            audioToggleButton.addEventListener('click', toggleAudio);
        }

        function toggleAudio() {
            if (Tone.context.state !== 'running') Tone.start();
            const button = document.getElementById('audio-toggle');
            if (isAudioOn) {
                button.textContent = '[ AUDIO OFF ]';
                button.classList.remove('bg-black', 'text-white');
                button.classList.add('text-black');
                isAudioOn = false;
            } else {
                button.textContent = '[ AUDIO ON ]';
                button.classList.add('bg-black', 'text-white');
                button.classList.remove('text-black');
                isAudioOn = true;
                playBleep('G5', '32n'); 
            }
        }

        function playBleep(note = "C5", duration = "64n") {
            if (isAudioOn && synth) {
                synth.triggerAttackRelease(note, duration, Tone.now());  
            }
        }

        function generateDataDecoration(productId) {
            const ref = productId.slice(-4); 
            const x = Math.floor(Math.random() * 899) + 100;
            const y = Math.floor(Math.random() * 89) + 10;
            return `[ REF: ${ref} // X: ${x} Y: ${y} ]`;
        }

        window.addEventListener('load', () => {
            initAnimation(); 
            if (width < 768) {
                currentState = STATE.CONVERGE;
            }
            animateLoop();
        });

        skipBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            endIntro();
        });

        overlay.addEventListener('click', async () => {
            await initAudioContext(); 
            toggleAudio(); 
            document.getElementById('intro-status').innerText = "_AUDIO_ENABLED_";
        });

        async function fetchData() {
            try {
                const response = await fetch('all_products_classified.json');
                if (!response.ok) throw new Error("JSON Fetch Failed");
                const jsonData = await response.json();
                const processed = jsonData.map(item => {
                    const prices = item.variations.map(v => v.price);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const displayPrice = minPrice === maxPrice
                        ? `NT$ ${minPrice.toLocaleString()}`
                        : `NT$ ${minPrice.toLocaleString()} - ${maxPrice.toLocaleString()}`;

                    return {
                        product_id: item.product_id,
                        product_name: item.product_name,
                        category_main: item.brand,
                        category_sub: item.major_category, 
                        numericPrice: minPrice,
                        displayPrice: displayPrice,
                        primaryImage: item.images[0],
                        secondImage: item.images[1] || item.images[0],
                        originalPrice: null,
                        images: item.images,
                        variations: item.variations.map(v => ({
                            variation_name: v.variation_name || '單一款式',
                            price: v.price,
                            stock: v.stock,
                            variation_images: v.variation_images
                        }))
                    };
                });
                allProducts = processed.sort((a, b) => b.product_id.localeCompare(a.product_id));
                const categories = {};
                processed.forEach(p => {
                    if (!categories[p.category_main]) categories[p.category_main] = [];
                    if (!categories[p.category_main].includes(p.category_sub)) {
                        categories[p.category_main].push(p.category_sub);
                    }
                });
                Object.keys(categories).forEach(main => {
                    categories[main].sort((a, b) => {
                        if (a === '玩偶/玩具') return -1;
                        if (b === '玩偶/玩具') return 1;
                        return a.localeCompare(b);
                    });
                });
                categoryData = categories;
                initApp();
            } catch (err) {
                console.warn("Using Fallback Data:", err);
                const fallbackData = [
                    {
                        "product_id": "40176921182",
                        "product_name": "全新可哀想? 內褲兔Opanchu 手掌大無奈小娃娃玩偶",
                        "brand": "內褲兔 (Opanchu)",
                        "major_category": "玩偶/玩具",
                        "images": [
                            "https://s-cf-tw.shopeesz.com/file/tw-11134207-81ztp-mhqbwgblghz5bf",
                            "https://s-cf-tw.shopeesz.com/file/tw-11134207-81ztq-mhqbwg9nysjo56"
                        ],
                        "variations": [
                            { "variation_name": "標準款", "price": 310.0, "stock": 1 }
                        ]
                    },
                    {
                        "product_id": "40276199056",
                        "product_name": "全新 hello kitty 蘋果限定玩偶",
                        "brand": "三麗鷗 (Sanrio)",
                        "major_category": "玩偶/玩具",
                        "images": [
                            "https://s-cf-tw.shopeesz.com/file/tw-11134207-81ztl-mgr7cc6t79ceee",
                            "https://s-cf-tw.shopeesz.com/file/tw-11134207-81zth-mgr7cc6t8nwua4"
                        ],
                        "variations": [
                            { "variation_name": "手機吊飾", "price": 780.0, "stock": 1 },
                            { "variation_name": "玩偶吊飾", "price": 780.0, "stock": 1 }
                        ]
                    },
                ];
                allProducts = fallbackData.map(item => {
                    const prices = item.variations.map(v => v.price);
                    const minPrice = Math.min(...prices);
                    return {
                        product_id: item.product_id,
                        product_name: item.product_name,
                        category_main: item.brand,
                        category_sub: item.major_category,
                        numericPrice: minPrice,
                        displayPrice: `NT$ ${minPrice}`,
                        primaryImage: item.images[0],
                        secondImage: item.images[1] || item.images[0],
                        images: item.images,
                        variations: item.variations.map(v => ({
                            variation_name: v.variation_name || '單一款式',
                            price: v.price,
                            stock: v.stock
                        }))
                    };
                });
                categoryData = { "內褲兔 (Opanchu)": ["玩偶/玩具"], "三麗鷗 (Sanrio)": ["玩偶/玩具"] };
                initApp();
            }
        }

        // ==========================================
        // PART 3: CART SYSTEM & CHECKOUT (GOOGLE FORM)
        // ==========================================
        
        let cart = []; 

        function initCart() {
            const cartToggle = document.getElementById('cart-toggle');
            const closeCart = document.getElementById('close-cart');
            const cartOverlay = document.getElementById('cart-overlay');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (cartToggle) cartToggle.addEventListener('click', toggleCart);
            if (closeCart) closeCart.addEventListener('click', toggleCart);
            if (cartOverlay) cartOverlay.addEventListener('click', toggleCart);
            if (checkoutBtn) checkoutBtn.addEventListener('click', processCheckout);
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('cart-overlay');
            const isClosed = sidebar.classList.contains('translate-x-full');
            
            if (isClosed) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                playBleep('C6', '32n');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function addToCartHandler(productId, variationName, price) {
            const product = allProducts.find(p => p.product_id === productId);
            if (!product) return;

            // 修正：根據選擇的款式名稱，尋找對應的圖片
            let displayImage = product.primaryImage; // 預設為主圖

            if (variationName && variationName !== '單一款式') {
                const selectedVariation = product.variations.find(v => v.variation_name === variationName);
                // 檢查該變體是否有圖片
                if (selectedVariation && selectedVariation.variation_images && selectedVariation.variation_images.length > 0) {
                    const varImgData = selectedVariation.variation_images[0];
                    // 處理字串或物件格式的圖片資料
                    if (typeof varImgData === 'string') {
                        displayImage = varImgData;
                    } else if (varImgData && varImgData.option_image_url) {
                        displayImage = varImgData.option_image_url;
                    }
                }
            }

            const cartItem = {
                id: productId + '-' + variationName,
                productId: productId,
                name: product.product_name,
                image: displayImage, // 使用判斷後的圖片
                variation: variationName || '單一款式',
                price: price,
                qty: 1
            };

            const existingItem = cart.find(item => item.id === cartItem.id);
            if (existingItem) {
                existingItem.qty++;
            } else {
                cart.push(cartItem);
            }

            updateCartUI();
            toggleCart();
            playSuccessArpeggio();
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items-container');
            const countSpan = document.getElementById('cart-count');
            const totalSpan = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            let totalQty = 0;
            let totalPrice = 0;

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 font-mono text-sm mt-10">
                        :: NULL_DATA ::<br>購物車是空的
                    </div>
                `;
                checkoutBtn.disabled = true;
            } else {
                container.innerHTML = '';
                checkoutBtn.disabled = false;
                
                cart.forEach((item) => {
                    totalQty += item.qty;
                    totalPrice += item.price * item.qty;

                    const itemHTML = `
                        <div class="flex gap-4 items-start font-mono border-b border-dashed border-gray-300 pb-4 last:border-0">
                            <img src="${item.image}" class="w-16 h-16 object-cover border border-gray-300">
                            <div class="flex-1">
                                <div class="text-xs text-gray-500 mb-1 leading-none tracking-tighter">${item.productId}</div>
                                <h4 class="text-sm font-bold text-black leading-tight mb-1 line-clamp-2">${item.name}</h4>
                                <div class="text-xs text-red-600 mb-2 font-bold">[ ${item.variation} ]</div>
                                <div class="flex justify-between items-center">
                                    <span class="font-bold">NT$ ${item.price}</span>
                                    <div class="flex items-center border border-black">
                                        <button class="px-2 hover:bg-black hover:text-white transition" onclick="changeQty('${item.id}', -1)">-</button>
                                        <span class="px-2 text-sm min-w-[20px] text-center">${item.qty}</span>
                                        <button class="px-2 hover:bg-black hover:text-white transition" onclick="changeQty('${item.id}', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += itemHTML;
                });
            }

            countSpan.textContent = totalQty;
            totalSpan.textContent = `NT$ ${totalPrice.toLocaleString()}`;
        }

        window.changeQty = function(itemId, delta) {
            const item = cart.find(i => i.id === itemId);
            if (!item) return;

            item.qty += delta;
            if (item.qty <= 0) {
                cart = cart.filter(i => i.id !== itemId);
            }
            updateCartUI();
            playBleep('A4', '64n');
        }

        // --- NEW CHECKOUT LOGIC FOR GOOGLE FORM ---
        function processCheckout() {
            if (cart.length === 0) return;

            // 1. Generate Order Text
            let orderText = `【 SAMANTHA | 訂單請求 】\n`;
            orderText += `--------------------------------\n`;
            cart.forEach(item => {
                orderText += `■ ${item.name}\n`;
                orderText += `  規格: ${item.variation} x ${item.qty}\n`;
                orderText += `  小計: $${item.price * item.qty}\n`;
                orderText += `--------------------------------\n`;
            });
            const totalPrice = document.getElementById('cart-total').textContent;
            orderText += `\n💰 總金額: ${totalPrice}\n`;
            orderText += `🕒 時間: ${new Date().toLocaleString()}`;

            // 2. Encode for URL
            const encodedOrderText = encodeURIComponent(orderText);

            // 3. Construct URL
            // Check if user has updated the placeholder
            if (GOOGLE_FORM_URL.includes("YOUR_FORM_ID")) {
                alert("系統錯誤：尚未設定 Google 表單連結。\n請修改程式碼中的 GOOGLE_FORM_URL。");
                return;
            }

            const finalUrl = `${GOOGLE_FORM_URL}?usp=pp_url&${ORDER_FIELD_ID}=${encodedOrderText}`;

            // 4. Redirect
            const conf = confirm("即將跳轉至訂單確認表單。\n\n系統已自動填寫購物車內容，請補充您的聯絡資訊以利我們寄送賣場連結。");
            if(conf) {
                window.open(finalUrl, '_blank');
                cart = [];
                updateCartUI();
                toggleCart();
            }
        }

        // ==========================================
        // PART 4: APP LOGIC
        // ==========================================
        
        function initApp(){ 
            const logContainer = document.getElementById('system-log-container');
            if (logContainer) {
                logContainer.innerHTML = `
                    <div class="log-item"><span class="log-date">2025.11.30</span><span class="log-category">[ N E W ]</span><span class="log-content">內褲兔車長吊飾數據載入完成。</span></div>
                    <div class="log-item"><span class="log-date">2025.11.28</span><span class="log-category">[ UPDATE ]</span><span class="log-content">系統 Ver 1.0.3 上線，優化圖像濾波。</span></div>
                    <div class="log-item"><span class="log-date">2025.11.25</span><span class="log-category">[ CHI I KAWA ]</span><span class="log-content">吉伊卡哇伏見稻荷系列入庫。</span></div>
                `;
            }

            const mainFilter = document.getElementById('category-main-filter');
            if (mainFilter) {
                mainFilter.innerHTML = '<option value="all">:: ALL CATEGORIES</option>';
                Object.keys(categoryData).forEach(main => {
                    const option = document.createElement('option');
                    option.value = main;
                    option.textContent = main;
                    mainFilter.appendChild(option);
                });
                mainFilter.addEventListener('change', (e) => {
                    renderSubCategory(e.target.value);
                    processProducts();
                });
            }
            
            const subFilter = document.getElementById('category-sub-filter');
            if (subFilter) subFilter.addEventListener('change', processProducts);

            renderNavigationLinks(categoryData);
            renderLandingPage(categoryData);

            const menuToggle = document.getElementById('menu-toggle');
            const navLinks = document.getElementById('nav-links');
            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', () => {
                    navLinks.classList.toggle('-translate-x-full');
                    navLinks.classList.toggle('opacity-0');
                    navLinks.classList.toggle('pointer-events-none');
                });
            }
            
            const sortBy = document.getElementById('sort-by');
            if (sortBy) sortBy.addEventListener('change', processProducts);

            const backToGrid = document.getElementById('back-to-grid');
            if (backToGrid) backToGrid.addEventListener('click', () => showProductGrid('all'));

            const addToCartBtn = document.querySelector('.add-to-cart');
            if (addToCartBtn) {
                addToCartBtn.onclick = function() {
                    const btn = this;
                    const currentId = document.getElementById('product_id') ? document.getElementById('product_id').textContent : null;
                    if(!currentId) return;
                    const selectedVarBtn = document.querySelector('.variation-button.ring-accent-color');
                    let selectedVarName = "預設";
                    let selectedPrice = 0;
                    const product = allProducts.find(p => p.product_id === currentId);
                    if (!product) return;
                    if (selectedVarBtn) {
                        const btnText = selectedVarBtn.textContent;
                        selectedVarName = btnText.split(' (NT$')[0];
                        const variant = product.variations.find(v => v.variation_name === selectedVarName);
                        selectedPrice = variant ? variant.price : product.numericPrice;
                    } else {
                        if(product.variations.length > 0 && product.variations[0].variation_name !== '單一款式') {
                             alert("請先選擇款式 // SELECT_VARIATION");
                             return; 
                        }
                        selectedVarName = "單一款式";
                        selectedPrice = product.numericPrice;
                    }
                    if (!btn.classList.contains('animate-pulse')) {
                        btn.classList.add('animate-pulse');
                        setTimeout(() => btn.classList.remove('animate-pulse'), 900);
                    }
                    addToCartHandler(currentId, selectedVarName, selectedPrice);
                };
            }

            const tooltip = document.getElementById('cursor-tooltip');
            document.addEventListener('mousemove', (e) => {
                tooltip.style.left = e.clientX + 'px';
                tooltip.style.top = e.clientY + 'px';
            });
            document.body.addEventListener('mouseover', (e) => {
                const card = e.target.closest('.product-card');
                if (card) {
                    tooltip.style.opacity = '1';
                } else {
                    tooltip.style.opacity = '0';
                }
            });
            initCart();
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });
        
        window.addEventListener('resize', () => {
            resizeAnimation();
            if(currentState !== STATE.END) initAnimation();
        });

        function renderNavigationLinks(catData) {
            const navLinksContainer = document.getElementById('nav-links');
            if (!navLinksContainer) return;
            navLinksContainer.innerHTML = ''; 
            Object.keys(catData).forEach(mainCategory => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'text-2xl lg:text-sm hover:text-gray-500 transition-colors text-black';
                link.textContent = mainCategory;
                link.onclick = (e) => {
                    e.preventDefault();
                    playBleep('G4', '64n'); 
                    showProductGrid(mainCategory);
                    const navLinks = document.getElementById('nav-links');
                    if (navLinks) navLinks.classList.add('-translate-x-full', 'opacity-0', 'pointer-events-none');
                };
                navLinksContainer.appendChild(link);
            });
        }

        function renderSubCategory(mainCategory) {
            const subFilter = document.getElementById('category-sub-filter');
            if (!subFilter) return;
            subFilter.innerHTML = '<option value="all">:: ALL SUB-CATEGORIES</option>';
            subFilter.disabled = true;
            if (mainCategory === 'all' || !categoryData[mainCategory]) return;
            const subCategories = categoryData[mainCategory];
            if (subCategories && subCategories.length > 0) {
                subCategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subFilter.appendChild(option);
                });
                subFilter.disabled = false;
            }
        }

        function renderLandingPage(catData) {
            const landingGrid = document.getElementById('landing-category-grid');
            if (!landingGrid) return;
            landingGrid.innerHTML = ''; 
            const categoriesToRender = Object.keys(catData).filter(cat => featuredCategories.includes(cat));
            categoriesToRender.forEach((mainCategory, index) => {
                const firstProduct = allProducts.find(p => p.category_main === mainCategory&& p.category_sub === "玩偶/玩具");
                const coverImage = firstProduct ? firstProduct.primaryImage : 'https://placehold.co/800x600/BBBBBB/333333?text=Category';
                const cardHTML = `
                    <div class="vertical-category-card" onclick="showProductGrid('${mainCategory}')">
                        <div class="category-image-container">
                            <img src="${coverImage}" alt="${mainCategory}" />
                        </div>
                        <div class="category-info">
                            <h2>${mainCategory}</h2>
                            <p>:: C O D E &nbsp; S E G M E N T &nbsp; ${index + 1} ::</p>
                            <p class="mt-2 text-sm" style="color: var(--code-comment);">專門收錄該系列周邊的精確數據檔案。</p>
                            <a href="#" class="category-view-link" onclick="event.stopPropagation(); showProductGrid('${mainCategory}');">
                                [ V I E W _ A R C H I V E ]
                            </a>
                        </div>
                    </div>
                `;
                landingGrid.innerHTML += cardHTML;
            });
            showLandingPage();
        }

        function processProducts() {
            let products = [...allProducts];
            const mainCategory = document.getElementById('category-main-filter') ? document.getElementById('category-main-filter').value : 'all';
            const subCategory = document.getElementById('category-sub-filter') ? document.getElementById('category-sub-filter').value : 'all';
            if (mainCategory !== 'all') products = products.filter(p => p.category_main === mainCategory);
            if (subCategory !== 'all') products = products.filter(p => p.category_sub === subCategory);
            const sortBy = document.getElementById('sort-by');
            const sortMethod = sortBy ? sortBy.value : 'default';
            if (sortMethod === 'price-asc') products.sort((a, b) => a.numericPrice - b.numericPrice);
            else if (sortMethod === 'price-desc') products.sort((a, b) => b.numericPrice - a.numericPrice);
            renderProducts(products);
        }

        function renderProducts(products) {
            const container = document.getElementById('product-grid');
            if (!container) return;
            let htmlContent = '';
            products.forEach(product => {
                const dataDeco = generateDataDecoration(product.product_id);
                const productHTML = `
                    <div class="product-card text-center cursor-pointer" data-product-id="${product.product_id}">
                        <a href="#" class="product-link block" 
                           onclick="event.preventDefault(); showProductDetail('${product.product_id}');"
                           onmouseover="this.querySelector('img').src = '${product.secondImage}'"
                           onmouseout="this.querySelector('img').src = '${product.primaryImage}'">
                            <img src="${product.primaryImage}" alt="${product.product_name}" class="w-full h-auto object-cover mb-4 rounded-lg" loading="lazy">
                        </a>
                        <div class="product-info">
                            <h3 class="product-name text-base font-normal mb-1 uppercase text-black">${product.product_name}</h3>
                            <p class="product-price text-sm font-bold">${product.displayPrice}</p>
                            <p class="data-decoration">${dataDeco}</p>
                        </div>
                    </div>
                `;
                htmlContent += productHTML;
            });
            container.innerHTML = htmlContent;
        }

        function showProductDetail(id) {
            playBleep('D5', '64n'); 
            const product = allProducts.find(p => p.product_id === id);
            if (!product) return;
            const mainImage = document.getElementById('detail-main-image');
            const productidSpan = document.getElementById('product_id'); 
            const detailName = document.getElementById('detail-name');
            const priceRange = document.getElementById('detail-price-range');
            const originalPriceElement = document.getElementById('detail-original-price'); 
            const mainTitle = document.getElementById('main-title');
            const thumbnailsContainer = document.getElementById('detail-thumbnails');
            const variationOptionsContainer = document.getElementById('variation-options');
            
            if (mainImage) mainImage.src = product.primaryImage;
            if (productidSpan) productidSpan.textContent = product.product_id; 
            if (detailName) detailName.textContent = product.product_name;
            if (priceRange) priceRange.textContent = product.displayPrice;
            if (originalPriceElement) {
                 if (product.originalPrice) {
                    originalPriceElement.textContent = `NT$ ${product.originalPrice.toLocaleString()}`;
                    originalPriceElement.classList.remove('hidden');
                 } else {
                    originalPriceElement.classList.add('hidden');
                 }
            }
            if (mainTitle) {
                mainTitle.textContent = product.product_name;
                mainTitle.style.fontFamily = "'Inter', sans-serif"; 
                mainTitle.style.fontWeight = "900";
                mainTitle.style.fontSize = '2.2rem';
                mainTitle.style.color = '#000';
            }
            if (thumbnailsContainer) {
                thumbnailsContainer.innerHTML = ''; 
                product.images.forEach((imgUrl, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = imgUrl;
                    thumbnail.className = `w-16 h-16 object-cover border cursor-pointer transition duration-200 rounded-sm ${index === 0 ? 'border-2 border-red-500' : 'border-gray-600'}`;
                    thumbnail.onclick = () => {
                        mainImage.src = imgUrl;
                        playBleep('E5', '64n');
                        document.querySelectorAll('#detail-thumbnails img').forEach(t => t.classList.remove('border-2', 'border-red-500'));
                        thumbnail.classList.add('border-2', 'border-red-500');
                    };
                    thumbnailsContainer.appendChild(thumbnail);
                });
            }
            if (variationOptionsContainer) {
                variationOptionsContainer.innerHTML = '';
                product.variations.forEach((v, index) => {
                    const btn = document.createElement('button');
                    btn.className = `variation-button px-4 py-2 text-sm transition duration-200 rounded-sm bg-black hover:bg-white hover:text-black ${index === 0 ? 'ring-2 ring-accent-color' : ''}`; // 預設選取第一個
                    btn.textContent = `${v.variation_name} (NT$ ${v.price})`;
                    btn.onclick = (e) => {
                        playBleep('G5', '64n');
                        // 1. 移除其他按鈕樣式
                        document.querySelectorAll('.variation-button').forEach(b => b.classList.remove('ring-2', 'ring-accent-color'));
                        e.target.classList.add('ring-2', 'ring-accent-color');

                        // 2. 更新價格顯示為該款式價格
                        if (priceRange) priceRange.textContent = `NT$ ${v.price.toLocaleString()}`;

                        // 3. 更新圖片 (如果有款式圖片的話)
                        if (v.variation_images && v.variation_images.length > 0) {
                            let imgUrl = null;
                            // 判斷圖片資料結構是字串還是物件
                            if (typeof v.variation_images[0] === 'string') {
                                imgUrl = v.variation_images[0];
                            } else if (v.variation_images[0].option_image_url) {
                                imgUrl = v.variation_images[0].option_image_url;
                            }
                            
                            if (imgUrl && mainImage) {
                                mainImage.src = imgUrl;
                                // 移除縮圖選中狀態，因為現在顯示的是變體圖
                                document.querySelectorAll('#detail-thumbnails img').forEach(t => t.classList.remove('border-2', 'border-red-500'));
                            }
                        }
                    };
                    variationOptionsContainer.appendChild(btn);
                });
            }
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('product-grid-container').classList.add('hidden');
            document.getElementById('filter-controls').classList.add('hidden');
            document.getElementById('product-detail-view').classList.remove('hidden');
        }

        function showProductGrid(mainCategory = 'all') {
            playBleep('A4', '64n');
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                mainTitle.removeAttribute('style'); 
                mainTitle.textContent = "【 // CURATED ARCHIVE 】"; 
                mainTitle.style.color = '#000';
            }
            const mainFilter = document.getElementById('category-main-filter');
            if (mainFilter) {
                mainFilter.value = mainCategory;
                renderSubCategory(mainCategory);
            }
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('product-detail-view').classList.add('hidden');
            document.getElementById('product-grid-container').classList.remove('hidden');
            document.getElementById('filter-controls').classList.remove('hidden');
            processProducts(); 
        }

        function showLandingPage() {
            document.getElementById('product-grid-container').classList.add('hidden');
            document.getElementById('filter-controls').classList.add('hidden');
            document.getElementById('product-detail-view').classList.add('hidden');
            document.getElementById('landing-view').classList.remove('hidden');
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                mainTitle.removeAttribute('style'); 
                mainTitle.textContent = "【 // CURATED ARCHIVE 】"; 
                mainTitle.style.color = '#000';
            }
        }

    </script>
</body>
</html>
